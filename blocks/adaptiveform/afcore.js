import{_ as e}from"./lite.js";console.time("script json-formula");var t={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_CLASS:10,TYPE_ARRAY_ARRAY:11},n={TOK_EOF:"EOF",TOK_UNQUOTEDIDENTIFIER:"UnquotedIdentifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_FIELD:"Field",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_MULTIPLY:"Multiply",TOK_POWER:"Power",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_EQ:"EQ",TOK_GT:"GT",TOK_LT:"LT",TOK_GTE:"GTE",TOK_LTE:"LTE",TOK_NE:"NE",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_LITERAL:"Literal"};const{TYPE_NUMBER:r,TYPE_ANY:s,TYPE_STRING:i,TYPE_ARRAY:o,TYPE_OBJECT:a,TYPE_BOOLEAN:l,TYPE_EXPREF:u,TYPE_NULL:c,TYPE_ARRAY_NUMBER:h,TYPE_ARRAY_STRING:d,TYPE_CLASS:p,TYPE_ARRAY_ARRAY:_}=t,{TOK_EXPREF:f}=n,g={[r]:"number",[s]:"any",[i]:"string",[o]:"array",[a]:"object",[l]:"boolean",[u]:"expression",[c]:"null",[h]:"Array<number>",[d]:"Array<string>",[p]:"class",[_]:"Array<array>"};function m(e,t=!0){if(null===e)return c;let n=e;if(t){if("function"!=typeof e.valueOf)return a;n=e.valueOf.call(e)}switch(Object.prototype.toString.call(n)){case"[object String]":return i;case"[object Number]":return r;case"[object Array]":return o;case"[object Boolean]":return l;case"[object Null]":return c;case"[object Object]":return n.jmespathType===f?u:a;default:return a}}function y(e){return[m(e),m(e,!1)]}function v(e,t,n,u,f,m){const E=e[0];if(-1!==t.findIndex(e=>e===s||E===e))return n;let T=!1;if((E===a||1===t.length&&t[0]===p)&&(T=!0),E===o&&1===t.length&&t[0]===a&&(T=!0),t.includes(_)){if(E===o&&(n.forEach(e=>{e instanceof Array||(T=!0)}),!T))return n;T=!0}if(T)throw new Error(`TypeError: ${u} expected argument to be type ${g[t[0]]} but received type ${g[E]} instead.`);let b=-1;if(E===o&&t.includes(d)&&t.includes(h)&&(b=n.length>0&&"string"==typeof n[0]?d:h),-1===b&&[d,h,o].includes(E)&&(b=t.find(e=>[d,h,o].includes(e))),-1===b&&([b]=t),b===s)return n;if(b===d||b===h||b===o){if(b===o)return E===h||E===d?n:null===n?[]:[n];const t=b===h?r:i;if(E===o){const e=n.slice();for(let n=0;n<e.length;n+=1){const r=y(e[n]);e[n]=v(r,[t],e[n],u,f,m)}return e}if([r,i,c,l].includes(t))return[v(e,[t],n,u,f,m)]}else{if(b===r)return[i,l,c].includes(E)?f(n):0;if(b===i)return E===c||E===a?"":m(n);if(b===l)return!!n;if(b===a&&e[1]===a)return n}throw new Error("unhandled argument")}function E(e){return null!==e&&"[object Array]"===Object.prototype.toString.call(e)}function T(e){return null!==e&&"[object Object]"===Object.prototype.toString.call(e)}function b(e){return null==e?e:E(e)?e.map(e=>b(e)):"function"!=typeof e.valueOf?e:e.valueOf()}function O(e,t){const n=b(e),r=b(t);if(n===r)return!0;if(Object.prototype.toString.call(n)!==Object.prototype.toString.call(r))return!1;if(!0===E(n)){if(n.length!==r.length)return!1;for(let e=0;e<n.length;e+=1)if(!1===O(n[e],r[e]))return!1;return!0}if(!0===T(n)){const e={};for(const t in n)if(hasOwnProperty.call(n,t)){if(!1===O(n[t],r[t]))return!1;e[t]=!0}for(const t in r)if(hasOwnProperty.call(r,t)&&!0!==e[t])return!1;return!0}return!1}const{TOK_CURRENT:N,TOK_GLOBAL:M,TOK_EXPREF:R,TOK_PIPE:x,TOK_EQ:j,TOK_GT:P,TOK_LT:w,TOK_GTE:$,TOK_LTE:I,TOK_NE:D,TOK_FLATTEN:A}=n,{TYPE_STRING:S,TYPE_ARRAY_STRING:Y,TYPE_ARRAY:k}=t;function C(e){if(null===e)return!0;const t=b(e);if(""===t||!1===t||null===t)return!0;if(E(t)&&0===t.length)return!0;if(T(t)){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}return!t}class U{constructor(e,t,n,r,s,i){this.runtime=e,this.globals=t,this.toNumber=n,this.toString=r,this.debug=s,this.language=i}search(e,t){return this.visit(e,t)}visit(e,t){const n=e&&{Field:(e,t)=>{if(null!==t&&(T(t)||E(t))){let n=t[e.name];if("function"==typeof n&&(n=void 0),void 0===n){try{this.debug.push(`Failed to find: '${e.name}'`);const n=Object.keys(t).map(e=>`'${e}'`).toString();n.length&&this.debug.push(`Available fields: ${n}`)}catch(e){}return null}return n}return null},Subexpression:(e,t)=>{let n=this.visit(e.children[0],t);for(let t=1;t<e.children.length;t+=1)if(n=this.visit(e.children[1],n),null===n)return null;return n},IndexExpression:(e,t)=>{const n=this.visit(e.children[0],t);return this.visit(e.children[1],n)},Index:(e,t)=>{if(E(t)){let n=this.toNumber(this.visit(e.value,t));n<0&&(n=t.length+n);const r=t[n];return void 0===r?(this.debug.push(`Index ${n} out of range`),null):r}if(T(t)){const n=this.toString(this.visit(e.value,t)),r=t[n];return void 0===r?(this.debug.push(`Key ${n} does not exist`),null):r}return this.debug.push(`left side of index expression ${t} is not an array or object.`),null},Slice:(e,t)=>{if(!E(t))return null;const n=e.children.slice(0).map(e=>null!=e?this.toNumber(this.visit(e,t)):null),r=this.computeSliceParams(t.length,n),[s,i,o]=r,a=[];if(o>0)for(let e=s;e<i;e+=o)a.push(t[e]);else for(let e=s;e>i;e+=o)a.push(t[e]);return a},Projection:(e,t)=>{const n=this.visit(e.children[0],t);if(!E(n))return null;const r=[];return n.forEach(t=>{const n=this.visit(e.children[1],t);null!==n&&r.push(n)}),r},ValueProjection:(e,t)=>{const n=this.visit(e.children[0],t);if(!T(b(n)))return null;const r=[];return Object.values(n).forEach(t=>{const n=this.visit(e.children[1],t);null!==n&&r.push(n)}),r},FilterProjection:(e,t)=>{const n=this.visit(e.children[0],t);if(!E(n))return null;const r=n.filter(t=>!C(this.visit(e.children[2],t))),s=[];return r.forEach(t=>{const n=this.visit(e.children[1],t);null!==n&&s.push(n)}),s},Comparator:(e,t)=>{const n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);if(e.name===j)return O(n,r);if(e.name===D)return!O(n,r);if(e.name===P)return n>r;if(e.name===$)return n>=r;if(e.name===w)return n<r;if(e.name===I)return n<=r;throw new Error(`Unknown comparator: ${e.name}`)},[A]:(e,t)=>{const n=this.visit(e.children[0],t);if(!E(n))return null;const r=[];return n.forEach(e=>{E(e)?r.push(...e):r.push(e)}),r},Identity:(e,t)=>t,MultiSelectList:(e,t)=>null===t?null:e.children.map(e=>this.visit(e,t)),MultiSelectHash:(e,t)=>{if(null===t)return null;const n={};return e.children.forEach(e=>{n[e.name]=this.visit(e.value,t)}),n},OrExpression:(e,t)=>{let n=this.visit(e.children[0],t);return C(n)&&(n=this.visit(e.children[1],t)),n},AndExpression:(e,t)=>{const n=this.visit(e.children[0],t);return!0===C(n)?n:this.visit(e.children[1],t)},AddExpression:(e,t)=>{const n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);return this.applyOperator(n,r,"+")},ConcatenateExpression:(e,t)=>{let n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);return n=v(y(n),[S,Y],n,"concatenate",this.toNumber,this.toString),r=v(y(r),[S,Y],r,"concatenate",this.toNumber,this.toString),this.applyOperator(n,r,"&")},UnionExpression:(e,t)=>{let n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);return n=v(y(n),[k],n,"union",this.toNumber,this.toString),r=v(y(r),[k],r,"union",this.toNumber,this.toString),n.concat(r)},SubtractExpression:(e,t)=>{const n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);return this.applyOperator(n,r,"-")},MultiplyExpression:(e,t)=>{const n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);return this.applyOperator(n,r,"*")},DivideExpression:(e,t)=>{const n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);return this.applyOperator(n,r,"/")},PowerExpression:(e,t)=>{const n=this.visit(e.children[0],t),r=this.visit(e.children[1],t);return this.applyOperator(n,r,"^")},NotExpression:(e,t)=>C(this.visit(e.children[0],t)),Literal:e=>e.value,Number:e=>e.value,[x]:(e,t)=>{const n=this.visit(e.children[0],t);return this.visit(e.children[1],n)},[N]:(e,t)=>t,[M]:e=>{const t=this.globals[e.name];return void 0===t?null:t},Function:(e,t)=>{if("if"===e.name)return this.runtime.callFunction(e.name,e.children,t,this,!1);const n=e.children.map(e=>this.visit(e,t));return this.runtime.callFunction(e.name,n,t,this)},ExpressionReference:e=>{const[t]=e.children;return t.jmespathType=R,t}}[e.type];if(!n)throw new Error(`Unknown/missing node type ${e&&e.type||""}`);return n(e,t)}computeSliceParams(e,t){function n(e,t,n){let r=t;return r<0?(r+=e,r<0&&(r=n<0?-1:0)):r>=e&&(r=n<0?e-1:e),r}let[r,s,i]=t;if(null===i)i=1;else if(0===i){const e=new Error("Invalid slice, step cannot be 0");throw e.name="RuntimeError",e}const o=i<0;return r=null===r?o?e-1:0:n(e,r,i),s=null===s?o?-1:e:n(e,s,i),[r,s,i]}applyOperator(e,t,n){if(E(e)&&E(t)){const r=e.length<t.length?e:t,s=Math.abs(e.length-t.length);r.length+=s,r.fill(null,r.length-s);const i=[];for(let r=0;r<e.length;r+=1)i.push(this.applyOperator(e[r],t[r],n));return i}if(E(e))return e.map(e=>this.applyOperator(e,t,n));if(E(t))return t.map(t=>this.applyOperator(e,t,n));if("*"===n)return this.toNumber(e)*this.toNumber(t);if("&"===n)return e+t;if("+"===n)return this.toNumber(e)+this.toNumber(t);if("-"===n)return this.toNumber(e)-this.toNumber(t);if("/"===n){const n=e/t;return Number.isFinite(n)?n:null}if("^"===n)return e**t;throw new Error(`Unknown operator: ${n}`)}}const{TOK_UNQUOTEDIDENTIFIER:K,TOK_QUOTEDIDENTIFIER:F,TOK_RBRACKET:L,TOK_RPAREN:B,TOK_COMMA:G,TOK_COLON:q,TOK_CONCATENATE:z,TOK_RBRACE:V,TOK_NUMBER:Q,TOK_CURRENT:J,TOK_GLOBAL:H,TOK_EXPREF:W,TOK_PIPE:X,TOK_OR:Z,TOK_AND:ee,TOK_ADD:te,TOK_SUBTRACT:ne,TOK_MULTIPLY:re,TOK_POWER:se,TOK_DIVIDE:ie,TOK_UNION:oe,TOK_EQ:ae,TOK_GT:le,TOK_LT:ue,TOK_GTE:ce,TOK_LTE:he,TOK_NE:de,TOK_FLATTEN:pe,TOK_STAR:_e,TOK_FILTER:fe,TOK_DOT:ge,TOK_NOT:me,TOK_LBRACE:ye,TOK_LBRACKET:ve,TOK_LPAREN:Ee,TOK_LITERAL:Te}=n,be={".":ge,",":G,":":q,"{":ye,"}":V,"]":L,"(":Ee,")":B,"@":J},Oe={"<":!0,">":!0,"=":!0,"!":!0},Ne={" ":!0,"\t":!0,"\n":!0};function Me(e,t){return e>="0"&&e<="9"||t&&"-"===e||"."===e}function Re(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e}function xe(e,t){const n=e[t];return"$"===n?e.length>t&&Re(e[t+1]):n>="a"&&n<="z"||n>="A"&&n<="Z"||"_"===n}class je{constructor(e=[],t=[]){this._allowedGlobalNames=e,this.debug=t}tokenize(e){const t=[];let n,r,s;for(this._current=0;this._current<e.length;){const i=t.length?t.slice(-1)[0].type:null;if(this._isGlobal(i,e,this._current))t.push(this._consumeGlobal(e));else if(xe(e,this._current))n=this._current,r=this._consumeUnquotedIdentifier(e),t.push({type:K,value:r,start:n});else if(void 0!==be[e[this._current]])t.push({type:be[e[this._current]],value:e[this._current],start:this._current}),this._current+=1;else if("-"===e[this._current]&&![J,Q,B,K,F,L].includes(i)||Me(e[this._current],!1))s=this._consumeNumber(e),t.push(s);else if("["===e[this._current])s=this._consumeLBracket(e),t.push(s);else if('"'===e[this._current])n=this._current,r=this._consumeQuotedIdentifier(e),t.push({type:F,value:r,start:n});else if("'"===e[this._current])n=this._current,r=this._consumeRawStringLiteral(e),t.push({type:Te,value:r,start:n});else if("`"===e[this._current]){n=this._current;const r=this._consumeLiteral(e);t.push({type:Te,value:r,start:n})}else if(void 0!==Oe[e[this._current]])t.push(this._consumeOperator(e));else if(void 0!==Ne[e[this._current]])this._current+=1;else if("&"===e[this._current])n=this._current,this._current+=1,"&"===e[this._current]?(this._current+=1,t.push({type:ee,value:"&&",start:n})):t.push(i===G||i===Ee?{type:W,value:"&",start:n}:{type:z,value:"&",start:n});else if("~"===e[this._current])n=this._current,this._current+=1,t.push({type:oe,value:"~",start:n});else if("+"===e[this._current])n=this._current,this._current+=1,t.push({type:te,value:"+",start:n});else if("-"===e[this._current])n=this._current,this._current+=1,t.push({type:ne,value:"-",start:n});else if("*"===e[this._current]){n=this._current,this._current+=1;const e=t.length&&t.slice(-1)[0].type;0===t.length||[ve,ge,X,ee,Z,G,q].includes(e)?t.push({type:_e,value:"*",start:n}):t.push({type:re,value:"*",start:n})}else if("/"===e[this._current])n=this._current,this._current+=1,t.push({type:ie,value:"/",start:n});else if("^"===e[this._current])n=this._current,this._current+=1,t.push({type:se,value:"^",start:n});else{if("|"!==e[this._current]){const t=new Error(`Unknown character:${e[this._current]}`);throw t.name="LexerError",t}n=this._current,this._current+=1,"|"===e[this._current]?(this._current+=1,t.push({type:Z,value:"||",start:n})):t.push({type:X,value:"|",start:n})}}return t}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&Re(e[this._current]);)this._current+=1;return e.slice(t,this._current)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const n=e.length;let r=!xe(e,t+1);for(;'"'!==e[this._current]&&this._current<n;){let t=this._current;Re(e[t])||(r=!0),t+="\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?1:2,this._current=t}this._current+=1;const s=e.slice(t,this._current);try{r&&!s.includes(" ")||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? '${s.replace(/"/g,"")}'?`))}catch(e){}return JSON.parse(s)}_consumeRawStringLiteral(e){const t=this._current;this._current+=1;const n=e.length;for(;"'"!==e[this._current]&&this._current<n;){let t=this._current;t+="\\"!==e[t]||"\\"!==e[t+1]&&"'"!==e[t+1]?1:2,this._current=t}return this._current+=1,e.slice(t+1,this._current-1).replaceAll("\\'","'")}_consumeNumber(e){const t=this._current;this._current+=1;const n=e.length;for(;Me(e[this._current],!1)&&this._current<n;)this._current+=1;const r=e.slice(t,this._current);let s;return s=r.includes(".")?parseFloat(r):parseInt(r,10),{type:Q,value:s,start:t}}_consumeLBracket(e){const t=this._current;return this._current+=1,"?"===e[this._current]?(this._current+=1,{type:fe,value:"[?",start:t}):"]"===e[this._current]?(this._current+=1,{type:pe,value:"[]",start:t}):{type:ve,value:"[",start:t}}_isGlobal(e,t,n){if(null!==e&&e===ge)return!1;if("$"!==t[n])return!1;let r=n+1;for(;r<t.length&&Re(t[r]);)r+=1;const s=t.slice(n,r);return this._allowedGlobalNames.includes(s)}_consumeGlobal(e){const t=this._current;for(this._current+=1;this._current<e.length&&Re(e[this._current]);)this._current+=1;const n=e.slice(t,this._current);return{type:H,name:n,start:t}}_consumeOperator(e){const t=this._current,n=e[t];return this._current+=1,"!"===n?"="===e[this._current]?(this._current+=1,{type:de,value:"!=",start:t}):{type:me,value:"!",start:t}:"<"===n?"="===e[this._current]?(this._current+=1,{type:he,value:"<=",start:t}):{type:ue,value:"<",start:t}:">"===n?"="===e[this._current]?(this._current+=1,{type:ce,value:">=",start:t}):{type:le,value:">",start:t}:"="===e[this._current]?(this._current+=1,{type:ae,value:"==",start:t}):{type:ae,value:"=",start:t}}_consumeLiteral(e){this._current+=1;const t=this._current,n=e.length;let r,s=!1;for(;(s||"`"!==e[this._current])&&this._current<n;){let t=this._current;s&&"\\"===e[t]&&'"'===e[t+1]?t+=2:('"'===e[t]&&(s=!s),t+=s&&"`"===e[t+1]?2:"\\"!==e[t]||"\\"!==e[t+1]&&"`"!==e[t+1]?1:2),this._current=t}let i=e.slice(t,this._current).trimStart();return i=i.replaceAll("\\`","`"),r=function(e){if(""===e)return!1;if('[{"'.includes(e[0]))return!0;if(["true","false","null"].includes(e))return!0;if(!"-0123456789".includes(e[0]))return!1;try{return JSON.parse(e),!0}catch(e){return!1}}(i)?JSON.parse(i):JSON.parse(`"${i}"`),this._current+=1,r}}const{TOK_LITERAL:Pe,TOK_COLON:we,TOK_EOF:$e,TOK_UNQUOTEDIDENTIFIER:Ie,TOK_QUOTEDIDENTIFIER:De,TOK_RBRACKET:Ae,TOK_RPAREN:Se,TOK_COMMA:Ye,TOK_CONCATENATE:ke,TOK_RBRACE:Ce,TOK_NUMBER:Ue,TOK_CURRENT:Ke,TOK_GLOBAL:Fe,TOK_FIELD:Le,TOK_EXPREF:Be,TOK_PIPE:Ge,TOK_OR:qe,TOK_AND:ze,TOK_ADD:Ve,TOK_SUBTRACT:Qe,TOK_MULTIPLY:Je,TOK_POWER:He,TOK_DIVIDE:We,TOK_UNION:Xe,TOK_EQ:Ze,TOK_GT:et,TOK_LT:tt,TOK_GTE:nt,TOK_LTE:rt,TOK_NE:st,TOK_FLATTEN:it,TOK_STAR:ot,TOK_FILTER:at,TOK_DOT:lt,TOK_NOT:ut,TOK_LBRACE:ct,TOK_LBRACKET:ht,TOK_LPAREN:dt}=n,pt={[$e]:0,[Ie]:0,[De]:0,[Ae]:0,[Se]:0,[Ye]:0,[Ce]:0,[Ue]:0,[Ke]:0,[Fe]:0,[Le]:0,[Be]:0,[Ge]:1,[qe]:2,[ze]:3,[Ve]:6,[Qe]:6,[ke]:7,[Je]:7,[We]:7,[He]:7,[Xe]:7,[Ze]:5,[et]:5,[tt]:5,[nt]:5,[rt]:5,[st]:5,[it]:9,[ot]:20,[at]:21,[lt]:40,[ut]:45,[ct]:50,[ht]:55,[dt]:60};class _t{constructor(e=[]){this._allowedGlobalNames=e}parse(e,t){this._loadTokens(e,t),this.index=0;const n=this.expression(0);if(this._lookahead(0)!==$e){const e=this._lookaheadToken(0),t=new Error(`Unexpected token type: ${e.type}, value: ${e.value}`);throw t.name="ParserError",t}return n}_loadTokens(e,t){const n=new je(this._allowedGlobalNames,t).tokenize(e);n.push({type:$e,value:"",start:e.length}),this.tokens=n}expression(e){const t=this._lookaheadToken(0);this._advance();let n=this.nud(t),r=this._lookahead(0);for(;e<pt[r];)this._advance(),n=this.led(r,n),r=this._lookahead(0);return n}_lookahead(e){return this.tokens[this.index+e].type}_lookaheadToken(e){return this.tokens[this.index+e]}_advance(){this.index+=1}_getIndex(){return this.index}_setIndex(e){this.index=e}nud(e){let t,n,r,s,i;switch(e.type){case Pe:return{type:"Literal",value:e.value};case Ue:return{type:"Number",value:e.value};case Ie:return{type:"Field",name:e.value};case De:if(s={type:"Field",name:e.value},this._lookahead(0)===dt)throw new Error("Quoted identifier not allowed for function names.");return s;case ut:return n=this.expression(pt.Not),{type:"NotExpression",children:[n]};case ot:return t={type:"Identity"},n=this._lookahead(0)===Ae?{type:"Identity"}:this._parseProjectionRHS(pt.Star),{type:"ValueProjection",children:[t,n]};case at:return this.led(e.type,{type:"Identity"});case ct:return this._parseMultiselectHash();case it:return t={type:it,children:[{type:"Identity"}]},n=this._parseProjectionRHS(pt.Flatten),{type:"Projection",children:[t,n]};case ht:return this._lookahead(0)===ot&&this._lookahead(1)===Ae?(this._advance(),this._advance(),n=this._parseProjectionRHS(pt.Star),{type:"Projection",children:[{type:"Identity"},n]}):this._parseUnchainedIndexExpression();case Ke:return{type:Ke};case Fe:return{type:Fe,name:e.name};case Le:return{type:Le};case Be:return r=this.expression(pt.Expref),{type:"ExpressionReference",children:[r]};case dt:for(i=[];this._lookahead(0)!==Se;)r=this.expression(0),i.push(r);return this._match(Se),i[0];default:this._errorToken(e)}}led(e,t){let n,r,s,i,o,a,l,u,c;switch(e){case ke:return r=this.expression(pt.Concatenate),{type:"ConcatenateExpression",children:[t,r]};case lt:return l=pt.Dot,this._lookahead(0)!==ot?(r=this._parseDotRHS(l),{type:"Subexpression",children:[t,r]}):(this._advance(),r=this._parseProjectionRHS(l),{type:"ValueProjection",children:[t,r]});case Ge:return r=this.expression(pt.Pipe),{type:Ge,children:[t,r]};case qe:return r=this.expression(pt.Or),{type:"OrExpression",children:[t,r]};case ze:return r=this.expression(pt.And),{type:"AndExpression",children:[t,r]};case Ve:return r=this.expression(pt.Add),{type:"AddExpression",children:[t,r]};case Qe:return r=this.expression(pt.Subtract),{type:"SubtractExpression",children:[t,r]};case Je:return r=this.expression(pt.Multiply),{type:"MultiplyExpression",children:[t,r]};case We:return r=this.expression(pt.Divide),{type:"DivideExpression",children:[t,r]};case He:return r=this.expression(pt.Power),{type:"PowerExpression",children:[t,r]};case Xe:return r=this.expression(pt.Power),{type:"UnionExpression",children:[t,r]};case dt:for(s=t.name,i=[];this._lookahead(0)!==Se;)o=this.expression(0),this._lookahead(0)===Ye&&this._match(Ye),i.push(o);return this._match(Se),a={type:"Function",name:s,children:i},a;case at:return n=this.expression(0),this._match(Ae),r=this._lookahead(0)===it?{type:"Identity"}:this._parseProjectionRHS(pt.Filter),{type:"FilterProjection",children:[t,r,n]};case it:return u={type:it,children:[t]},c=this._parseProjectionRHS(pt.Flatten),{type:"Projection",children:[u,c]};case Ze:case st:case et:case nt:case tt:case rt:return this._parseComparator(t,e);case ht:return this._lookahead(0)===ot&&this._lookahead(1)===Ae?(this._advance(),this._advance(),r=this._parseProjectionRHS(pt.Star),{type:"Projection",children:[t,r]}):(r=this._parseChainedIndexExpression(),this._projectIfSlice(t,r));default:this._errorToken(this._lookaheadToken(0))}}_match(e){if(this._lookahead(0)!==e){const t=this._lookaheadToken(0),n=new Error(`Expected ${e}, got: ${t.type}`);throw n.name="ParserError",n}this._advance()}_errorToken(e){const t=new Error(`Invalid token (${e.type}): "${e.value}"`);throw t.name="ParserError",t}_parseChainedIndexExpression(){const e=this._getIndex();if(this._lookahead(0)===we)return this._parseSliceExpression();const t=this.expression(0);return this._lookahead(0)===we?(this._setIndex(e),this._parseSliceExpression()):(this._match(Ae),{type:"Index",value:t})}_parseUnchainedIndexExpression(){const e=this._getIndex(),t=this._lookahead(0);if(t===we){const e=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},e)}const n=this.expression(0),r=this._lookahead(0);if(r===Ye)return this._setIndex(e),this._parseMultiselectList();if(r===we){this._setIndex(e);const t=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},t)}return t===Ue?(this._match(Ae),{type:"Index",value:n}):(this._setIndex(e),this._parseMultiselectList())}_projectIfSlice(e,t){const n={type:"IndexExpression",children:[e,t]};return"Slice"===t.type?{type:"Projection",children:[n,this._parseProjectionRHS(pt.Star)]}:n}_parseSliceExpression(){const e=[null,null,null];let t=0,n=this._lookahead(0);for(;n!==Ae&&t<3;){if(n===we&&t<2)t+=1,this._advance();else{e[t]=this.expression(0);const n=this._lookahead(0);if(n!==we&&n!==Ae){const e=new Error(`Syntax error, unexpected token: ${n.value}(${n.type})`);throw e.name="Parsererror",e}}n=this._lookahead(0)}return this._match(Ae),{type:"Slice",children:e}}_parseComparator(e,t){return{type:"Comparator",name:t,children:[e,this.expression(pt[t])]}}_parseDotRHS(e){const t=this._lookahead(0);return[Ie,De,ot].indexOf(t)>=0?this.expression(e):t===ht?(this._match(ht),this._parseMultiselectList()):t===ct?(this._match(ct),this._parseMultiselectHash()):void 0}_parseProjectionRHS(e){let t;if(pt[this._lookahead(0)]<10)t={type:"Identity"};else if(this._lookahead(0)===ht)t=this.expression(e);else if(this._lookahead(0)===at)t=this.expression(e);else{if(this._lookahead(0)!==lt){const e=this._lookaheadToken(0),t=new Error(`Sytanx error, unexpected token: ${e.value}(${e.type})`);throw t.name="ParserError",t}this._match(lt),t=this._parseDotRHS(e)}return t}_parseMultiselectList(){const e=[];for(;this._lookahead(0)!==Ae;){const t=this.expression(0);if(e.push(t),this._lookahead(0)===Ye&&(this._match(Ye),this._lookahead(0)===Ae))throw new Error("Unexpected token Rbracket")}return this._match(Ae),{type:"MultiSelectList",children:e}}_parseMultiselectHash(){const e=[],t=[Ie,De];let n,r,s,i;if(this._lookahead(0)===Ce)return this._advance(),{type:"MultiSelectHash",children:[]};for(;;){if(n=this._lookaheadToken(0),t.indexOf(n.type)<0)throw new Error(`Expecting an identifier token, got: ${n.type}`);if(r=n.value,this._advance(),this._match(we),s=this.expression(0),i={type:"KeyValuePair",name:r,value:s},e.push(i),this._lookahead(0)===Ye)this._match(Ye);else if(this._lookahead(0)===Ce){this._match(Ce);break}}return{type:"MultiSelectHash",children:e}}}function ft(e,t){const n=10**t;return Math.round(e*n)/n}function gt(e,n,r,s=[]){return{casefold:{_func:(e,t,r)=>n(e[0]).toLocaleUpperCase(r.language).toLocaleLowerCase(r.language),_signature:[{types:[t.TYPE_STRING]}]},and:{_func:t=>{let n=!!e(t[0]);return t.slice(1).forEach(t=>{n=n&&!!e(t)}),n},_signature:[{types:[t.TYPE_ANY],variadic:!0}]},deepScan:{_func:e=>{const[t,n]=e,r=n.toString(),s=[];return null===t||function e(t){Object.entries(t).forEach(([t,n])=>{t===r&&s.push(n),"object"==typeof n&&e(n)})}(t),s},_signature:[{types:[t.TYPE_OBJECT,t.TYPE_ARRAY,t.TYPE_NULL]},{types:[t.TYPE_STRING,t.TYPE_NUMBER]}]},or:{_func:t=>{let n=!!e(t[0]);return t.slice(1).forEach(t=>{n=n||!!e(t)}),n},_signature:[{types:[t.TYPE_ANY],variadic:!0}]},not:{_func:t=>!e(t[0]),_signature:[{types:[t.TYPE_ANY]}]},null:{_func:()=>null,_signature:[]},true:{_func:()=>!0,_signature:[]},false:{_func:()=>!1,_signature:[]},if:{_func:(t,n,r)=>{const s=t[1],i=t[2],o=r.visit(t[0],n);return e(o)?r.visit(s,n):r.visit(i,n)},_signature:[{types:[t.TYPE_ANY]},{types:[t.TYPE_ANY]},{types:[t.TYPE_ANY]}]},substitute:{_func:e=>{const t=n(e[0]),s=n(e[1]),i=n(e[2]);if(e.length<=3)return t.replaceAll(s,i);const o=r(e[3]);if(o<1)return t;let a=-1;for(let e=0;e<o;e+=1){a+=1;const e=t.slice(a).indexOf(s);if(-1===e)return t;a+=e}return t.slice(0,a)+t.slice(a).replace(s,i)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER],optional:!0}]},value:{_func:e=>{const t=e[0]||{},n=e[1],r=t[n];if(void 0===r){s.push(`Failed to find: '${n}'`);const e=Object.keys(t).map(e=>`'${e}'`).toString();return e.length&&s.push(`Available fields: ${e}`),null}return r},_signature:[{types:[t.TYPE_OBJECT,t.TYPE_ARRAY,t.TYPE_NULL]},{types:[t.TYPE_STRING,t.TYPE_NUMBER]}]},lower:{_func:e=>n(e[0]).toLowerCase(),_signature:[{types:[t.TYPE_STRING]}]},upper:{_func:e=>n(e[0]).toUpperCase(),_signature:[{types:[t.TYPE_STRING]}]},exp:{_func:e=>{const t=r(e[0]);return Math.exp(t)},_signature:[{types:[t.TYPE_NUMBER]}]},power:{_func:e=>r(e[0])**r(e[1]),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},find:{_func:e=>{const t=n(e[0]),s=n(e[1]),i=e.length>2?r(e[2]):0,o=s.indexOf(t,i);return-1===o?null:o},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER],optional:!0}]},left:{_func:e=>{const t=e.length>1?r(e[1]):1;return t<0?null:e[0]instanceof Array?e[0].slice(0,t):n(e[0]).substr(0,t)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER],optional:!0}]},right:{_func:e=>{const t=e.length>1?r(e[1]):1;if(t<0)return null;if(e[0]instanceof Array)return 0===t?[]:e[0].slice(-1*t);const s=n(e[0]);return s.substr(s.length-t,t)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER],optional:!0}]},mid:{_func:e=>{const t=r(e[1]),s=r(e[2]);return t<0?null:e[0]instanceof Array?e[0].slice(t,t+s):n(e[0]).substr(t,s)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},mod:{_func:e=>r(e[0])%r(e[1]),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},proper:{_func:e=>n(e[0]).split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),_signature:[{types:[t.TYPE_STRING]}]},rept:{_func:e=>{const t=n(e[0]),s=r(e[1]);return s<0?null:t.repeat(s)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER]}]},replace:{_func:e=>{const t=n(e[0]),s=r(e[1]),i=r(e[2]),o=n(e[3]);return s<0?null:t.substr(0,s)+o+t.substr(s+i)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_STRING]}]},round:{_func:e=>ft(r(e[0]),r(e[1])),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},sqrt:{_func:e=>{const t=Math.sqrt(r(e[0]));return Number.isNaN(t)?null:t},_signature:[{types:[t.TYPE_NUMBER]}]},stdevp:{_func:e=>{const t=e[0]||[];if(0===t.length)return null;const n=t.map(e=>r(e)),s=n.reduce((e,t)=>e+t,0)/t.length,i=n.reduce((e,t)=>e+t*t,0)/t.length,o=Math.sqrt(i-s*s);return Number.isNaN(o)?null:o},_signature:[{types:[t.TYPE_ARRAY_NUMBER]}]},stdev:{_func:e=>{const t=e[0]||[];if(t.length<=1)return null;const n=t.map(e=>r(e)),s=n.reduce((e,t)=>e+t,0)/t.length,i=n.reduce((e,t)=>e+t*t,0),o=Math.sqrt((i-t.length*s*s)/(t.length-1));return Number.isNaN(o)?null:o},_signature:[{types:[t.TYPE_ARRAY_NUMBER]}]},trim:{_func:e=>n(e[0]).split(" ").filter(e=>e).join(" "),_signature:[{types:[t.TYPE_STRING]}]},trunc:{_func:e=>{const t=r(e[0]),n=e.length>1?r(e[1]):0;return(t>=0?Math.floor:Math.ceil)(t*10**n)/10**n},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0}]},charCode:{_func:e=>{const t=r(e[0]);return Number.isInteger(t)?String.fromCharCode(t):null},_signature:[{types:[t.TYPE_NUMBER]}]},codePoint:{_func:e=>{const t=n(e[0]);return 0===t.length?null:t.codePointAt(0)},_signature:[{types:[t.TYPE_STRING]}]},datetime:{_func:e=>{const t=r(e[0]),s=r(e[1]),i=r(e[2]),o=e.length>3?r(e[3]):0,a=e.length>4?r(e[4]):0,l=e.length>5?r(e[5]):0,u=e.length>6?r(e[6]):0,c=e.length>7?n(e[7]):null;let h=new Date(t,s-1,i,o,a,l,u);return c&&(h=function(e,t){if(null===e)return null;let n=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds());return n+=function(e,t){const n=new Intl.DateTimeFormat("en-US",{timeZone:t,timeZoneName:"longOffset"}).format(e),r=/GMT([+\-âˆ’])?(\d{1,2}):?(\d{0,2})?/.exec(n);if(!r)return 0;const[s,i,o]=r.slice(1),a=60*(60*(i||0)+1*(o||0))*1e3;return"-"===s?-1*a:a}(e,t),new Date(n)}(h,c)),h.getTime()/864e5},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_STRING],optional:!0}]},datedif:{_func:e=>{const t=r(e[0]),s=r(e[1]),i=n(e[2]).toLowerCase();if(s===t)return 0;if(s<t)return null;if("d"===i)return Math.floor(s-t);const o=new Date(864e5*t),a=new Date(864e5*s),l=a.getFullYear()-o.getFullYear();let u=a.getMonth()-o.getMonth();const c=a.getDate()-o.getDate();if("y"===i){let e=l;return u<0&&(e-=1),0===u&&c<0&&(e-=1),e}if("m"===i)return 12*l+u+(c<0?-1:0);if("ym"===i)return c<0&&(u-=1),u<=0&&l>0?12+u:u;if("yd"===i)return c<0&&(u-=1),a.setFullYear(u<0?o.getFullYear()+1:o.getFullYear()),Math.floor((a.getTime()-o.getTime())/864e5);throw new TypeError(`Unrecognized unit parameter "${i}" for datedif()`)},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_STRING]}]},eomonth:{_func:e=>{const t=r(e[0]),n=r(e[1]),s=new Date(864e5*t);return new Date(s.getFullYear(),s.getMonth()+n+1,0).getTime()/864e5},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},day:{_func:e=>{const t=r(e[0]);return new Date(864e5*t).getDate()},_signature:[{types:[t.TYPE_NUMBER]}]},month:{_func:e=>{const t=r(e[0]);return new Date(864e5*t).getMonth()+1},_signature:[{types:[t.TYPE_NUMBER]}]},year:{_func:e=>{const t=r(e[0]);return new Date(864e5*t).getFullYear()},_signature:[{types:[t.TYPE_NUMBER]}]},time:{_func:e=>{const t=(3600*r(e[0])+60*r(e[1])+r(e[2]))/86400;return t<0?null:t-Math.floor(t)},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},hour:{_func:e=>{const t=r(e[0])%1;if(t<0)return null;const n=ft(24*t,14);return Math.floor(n%24)},_signature:[{types:[t.TYPE_NUMBER]}]},minute:{_func:e=>{const t=r(e[0])%1;if(t<0)return null;const n=Math.round(1440*t,10);return Math.floor(n%60)},_signature:[{types:[t.TYPE_NUMBER]}]},second:{_func:e=>{const t=r(e[0])%1;if(t<0)return null;const n=ft(86400*t,10);return Math.floor(n%60)},_signature:[{types:[t.TYPE_NUMBER]}]},now:{_func:()=>Date.now()/864e5,_signature:[]},today:{_func:()=>Math.floor(Date.now()/864e5),_signature:[]},weekday:{_func:e=>{const t=r(e[0]),n=e.length>1?r(e[1]):1,s=new Date(864e5*t).getDay();switch(n){case 1:return s+1;case 2:return(s+6)%7+1;case 3:return(s+6)%7;default:return null}},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0}]},entries:{_func:t=>{const n=e(t[0]);return Object.entries(n)},_signature:[{types:[t.TYPE_NUMBER,t.TYPE_STRING,t.TYPE_ARRAY,t.TYPE_OBJECT,t.TYPE_BOOLEAN]}]},fromEntries:{_func:e=>Object.fromEntries(e[0]),_signature:[{types:[t.TYPE_ARRAY_ARRAY]}]},split:{_func:e=>{const t=n(e[0]),r=n(e[1]);return t.split(r)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]}]},unique:{_func:t=>{const n=t[0].map(t=>e(t));return t[0].filter((t,r)=>n.indexOf(e(t))===r)},_signature:[{types:[t.TYPE_ARRAY]}]},encodeUrlComponent:{_func:e=>encodeURIComponent(e[0]),_signature:[{types:[t.TYPE_STRING]}]},encodeUrl:{_func:e=>encodeURI(e[0]),_signature:[{types:[t.TYPE_STRING]}]},decodeUrlComponent:{_func:e=>decodeURIComponent(e[0]),_signature:[{types:[t.TYPE_STRING]}]},decodeUrl:{_func:e=>decodeURI(e[0]),_signature:[{types:[t.TYPE_STRING]}]}}}function mt(e,n,r,s,i,o,a){const{TYPE_NUMBER:l,TYPE_ANY:u,TYPE_STRING:c,TYPE_ARRAY:h,TYPE_OBJECT:d,TYPE_BOOLEAN:p,TYPE_EXPREF:_,TYPE_NULL:f,TYPE_ARRAY_NUMBER:g,TYPE_ARRAY_STRING:m}=t;function y(t,n){return r=>{const s=e.visit(t,r);if(n.indexOf(i(s))<0){const e=`TypeError: expected one of ${n}, received ${i(s)}`;throw new Error(e)}return s}}return{abs:{_func:e=>Math.abs(e[0]),_signature:[{types:[l]}]},avg:{_func:e=>{let t=0;const n=e[0];return n.forEach(e=>{t+=e}),t/n.length},_signature:[{types:[g]}]},ceil:{_func:e=>Math.ceil(e[0]),_signature:[{types:[l]}]},contains:{_func:e=>o(e[0]).indexOf(o(e[1]))>=0,_signature:[{types:[c,h]},{types:[u]}]},endsWith:{_func:e=>{const t=o(e[0]),n=o(e[1]);return-1!==t.indexOf(n,t.length-n.length)},_signature:[{types:[c]},{types:[c]}]},floor:{_func:e=>Math.floor(e[0]),_signature:[{types:[l]}]},length:{_func:e=>{const t=o(e[0]);return n(t)?Object.keys(t).length:r(t)?t.length:a(t).length},_signature:[{types:[c,h,d]}]},map:{_func:t=>{const n=t[0];return t[1].map(t=>e.visit(n,t))},_signature:[{types:[_]},{types:[h]}]},reduce:{_func:t=>{const n=t[0];return t[1].reduce((t,r,s,i)=>e.visit(n,{accumulated:t,current:r,index:s,array:i}),3===t.length?t[2]:null)},_signature:[{types:[_]},{types:[h]},{types:[u],optional:!0}]},max:{_func:e=>{if(e[0].length>0){const t=i(e[0][0]);return e[0].reduce(t===l?(e,t)=>s(e)>=s(t)?e:t:(e,t)=>a(t).localeCompare(a(e))<0?e:t,e[0][0])}return null},_signature:[{types:[h,g,m]}]},merge:{_func:e=>{const t={};return e.forEach(e=>{Object.entries(e).forEach(([e,n])=>{t[e]=n})}),t},_signature:[{types:[d],variadic:!0}]},maxBy:{_func:e=>{const t=e[0],n=y(e[1],[l,c]);let r,s,i=-Infinity;return t.forEach(e=>{s=n(e),s>i&&(i=s,r=e)}),r},_signature:[{types:[h]},{types:[_]}]},sum:{_func:e=>{let t=0;return e[0].forEach(e=>{t+=1*e}),t},_signature:[{types:[g]}]},startsWith:{_func:e=>o(e[0]).startsWith(o(e[1])),_signature:[{types:[c]},{types:[c]}]},min:{_func:e=>{if(e[0].length>0){if(i(e[0][0])===l)return e[0].reduce((e,t)=>s(e)<=s(t)?e:t,e[0][0]);const t=e[0];let n=t[0];for(let e=1;e<t.length;e+=1)a(t[e]).localeCompare(a(n))<0&&(n=t[e]);return n}return null},_signature:[{types:[h,g,m]}]},minBy:{_func:e=>{const t=e[0],n=y(e[1],[l,c]);let r,s,i=Infinity;return t.forEach(e=>{s=n(e),s<i&&(i=s,r=e)}),r},_signature:[{types:[h]},{types:[_]}]},type:{_func:e=>({[l]:"number",[c]:"string",[h]:"array",[d]:"object",[p]:"boolean",[_]:"expref",[f]:"null"}[i(e[0])]),_signature:[{types:[u]}]},keys:{_func:e=>null===e[0]?[]:Object.keys(e[0]),_signature:[{types:[u]}]},values:{_func:e=>{const t=o(e[0]);return null===t?[]:Object.values(t)},_signature:[{types:[u]}]},sort:{_func:e=>{const t=e[0].slice(0);if(t.length>0){const n=i(e[0][0])===l?s:a;t.sort((e,t)=>{const r=n(e),s=n(t);return r<s?-1:r>s?1:0})}return t},_signature:[{types:[h,m,g]}]},sortBy:{_func:t=>{const n=t[0].slice(0);if(0===n.length)return n;const r=t[1],s=i(e.visit(r,n[0]));if([l,c].indexOf(s)<0)throw new Error("TypeError");const o=[];for(let e=0;e<n.length;e+=1)o.push([e,n[e]]);o.sort((t,n)=>{const o=e.visit(r,t[1]),a=e.visit(r,n[1]);if(i(o)!==s)throw new Error(`TypeError: expected ${s}, received ${i(o)}`);if(i(a)!==s)throw new Error(`TypeError: expected ${s}, received ${i(a)}`);return o>a?1:o<a?-1:t[0]-n[0]});for(let e=0;e<o.length;e+=1)[,n[e]]=o[e];return n},_signature:[{types:[h]},{types:[_]}]},join:{_func:e=>e[1].join(e[0]),_signature:[{types:[c]},{types:[m]}]},reverse:{_func:e=>{const t=o(e[0]);if(i(t)===c){let e="";for(let n=t.length-1;n>=0;n-=1)e+=t[n];return e}const n=e[0].slice(0);return n.reverse(),n},_signature:[{types:[c,h]}]},toArray:{_func:e=>i(e[0])===h?e[0]:[e[0]],_signature:[{types:[u]}]},toString:{_func:e=>i(e[0])===c?e[0]:JSON.stringify(e[0]),_signature:[{types:[u]}]},toNumber:{_func:e=>{const t=i(e[0]);return t===l?e[0]:t===c?s(e[0]):null},_signature:[{types:[u]}]},notNull:{_func:e=>e.find(e=>i(e)!==f)||null,_signature:[{types:[u],variadic:!0}]},zip:{_func:e=>{const t=e.reduce((e,t)=>Math.min(e,t.length),e[0].length),n=new Array(t);for(let r=0;r<t;r+=1)n[r]=[],e.forEach(e=>{n[r].push(e[r])});return n},_signature:[{types:[h],variadic:!0}]}}}const{TYPE_CLASS:yt,TYPE_ANY:vt}=t;var Et=new function(){let t;function n(e){return null==e?"":e.toString()}class r{addFunctions(r,s={}){this.functionTable=e({},mt(this._interpreter,T,E,t,m,b,n),gt(b,n,t,r),s)}_validateArgs(e,r,s,i){if(0===s.length)return;let o;const a=s.filter(e=>!e.optional).length;if(s[s.length-1].variadic){if(r.length<s.length)throw o=1===s.length?" argument":" arguments",new Error(`ArgumentError: ${e}() takes at least${s.length}${o} but received ${r.length}`)}else if(r.length<a||r.length>s.length)throw o=1===s.length?" argument":" arguments",new Error(`ArgumentError: ${e}() takes ${s.length}${o} but received ${r.length}`);if(!i)return;let l,u;const c=Math.min(s.length,r.length);for(let i=0;i<c;i+=1)l=s[i].types,h=r[i],d=void 0,l.includes(yt)&&null!==(d=h)&&!Array.isArray(d)&&"Object"!==d.constructor.name||l.includes(vt)||(u=y(r[i]),r[i]=v(u,l,r[i],e,t,n));var h,d}callFunction(e,t,n,r,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,e))throw new Error(`Unknown function: ${e}()`);const i=this.functionTable[e];return this._validateArgs(e,t,i._signature,s),i._func.call(this,t,n,r)}}this.compile=function(e,t=[],n=[]){let r;try{r=new _t(t).parse(e,n)}catch(e){throw n.push(e.toString()),e}return r},this.search=function(e,s,i,o,a,l=[],u="en-US"){const c=new r(o);c.debug=l,t=function(e,t=[]){return n=>{const r=b(n);if(null===r)return null;if(r instanceof Array)return t.push("Converted array to zero"),0;const s=typeof r;return"number"===s?r:"string"===s?e(r,t):"boolean"===s?r?1:0:(t.push("Converted object to zero"),0)}}(a||(e=>{const t=+e;return Number.isNaN(t)?0:t}),l);const h=new U(c,i,t,n,l,u);c._interpreter=h,c.addFunctions(l,o);try{return h.search(e,s)}catch(e){throw l.push(e.message||e.toString()),e}},this.strictDeepEqual=O};class Tt{constructor(e,t={},n=null,r=[],s=[],i="en-US"){this.expression=e,this.customFunctions=t,this.stringToNumber=n,this.node=Et.compile(e,r,s),this.debug=s,this.language=i}search(t,n){return Et.search(this.node,t,n,e({},this.customFunctions),this.stringToNumber,this.debug,this.language)}}function bt(){return bt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},bt.apply(this,arguments)}console.timeEnd("script json-formula"),console.time("script af-core");const Ot=["description","placeholder","enum","enumNames","label.value","constraintMessages.accept","constraintMessages.enum","constraintMessages.exclusiveMinimum","constraintMessages.exclusiveMaximum","constraintMessages.format","constraintMessages.maxFileSize","constraintMessages.maxLength","constraintMessages.maximum","constraintMessages.maxItems","constraintMessages.minLength","constraintMessages.minimum","constraintMessages.minItems","constraintMessages.pattern","constraintMessages.required","constraintMessages.step","constraintMessages.type","constraintMessages.validationExpression"],Nt=["accept","enum","exclusiveMinimum","exclusiveMaximum","format","maxFileSize","maxLength","maximum","maxItems","minLength","minimum","minItems","pattern","required","step","validationExpression","enumNames"];class Mt{constructor(e="",t=[]){this.errorMessages=t,this.fieldName=e}}const Rt=e=>new Map(Object.entries(e)),xt=Rt({date:"date-input","data-url":"file-input",binary:"file-input"}),jt=Rt({number:"number-input",boolean:"checkbox",object:"panel",array:"panel",file:"file-input","file[]":"file-input"}),Pt=["string[]","boolean[]","number[]","array"],wt=e=>{const t=e.type||"string";return"enum"in e?e.enum.length>2||Pt.indexOf(t)>-1?"drop-down":"checkbox":"string"===t||"string[]"===t?xt.get(e.format)||"text-input":jt.get(t)||"text-input"},$t=e=>{if("items"in e){const t=e,n=t.items;if("array"===t.type)return{type:"array",items:$t(n[0]),minItems:null==t?void 0:t.minItems,maxItems:null==t?void 0:t.maxItems};{const e=n.filter(e=>null!=e.name);return{type:"object",properties:Object.fromEntries(e.map(e=>[e.name,$t(e)])),required:e.filter(e=>e.required).map(e=>e.name)}}}{var t;const n=e,r=["type","maxLength","minLength","minimum","maximum","format","pattern","step","enum"].reduce((e,t)=>(t in n&&null!=n[t]&&(e[t]=n[t]),e),{});if("none"===n.dataRef||0==Object.keys(r).length)return;return bt({title:null==(t=n.label)?void 0:t.value,description:n.description},r)}},It=e=>$t(e),Dt=(e,t,n)=>{if(t in e)return e[t];if(!t.startsWith(":")){const n=`:${t}`;if(n in e)return e[n]}return n},At=function(e){return"file"===(null==e?void 0:e.type)||"file[]"===(null==e?void 0:e.type)||("string"===(null==e?void 0:e.type)||"string[]"===(null==e?void 0:e.type))&&("binary"===(null==e?void 0:e.format)||"data-url"===(null==e?void 0:e.format))},St=function(e){return Nt.some(t=>void 0!==e[t])},Yt=function(e){return"checkbox"===((null==e?void 0:e.fieldType)||wt(e))},kt=function(e){return"checkbox-group"===((null==e?void 0:e.fieldType)||wt(e))},Ct=function(e){const t=(null==e?void 0:e.fieldType)||wt(e);return"text-input"===t&&"date"===(null==e?void 0:e.format)||"date-input"===t};function Ut(e,t){let n;return e instanceof Array?(n=[],n=e.map(e=>Ut(e,t))):"object"==typeof e&&null!==e?(n={},Object.entries(e).forEach(([e,r])=>{n[e]=Ut(r,t)})):n=e,t&&n&&n.id&&(n.id=t()),n}function Kt(e,t,n){if(null!=e&&null!=t){const r=bt({},t);return r[n]=e[n],""===Ft(e).replace(Ft(r),"")}return!1}const Ft=e=>JSON.stringify(e,null,2);class Lt{constructor(e,t,n){this._metadata=n,this._payload=e,this._type=t}get type(){return this._type}get payload(){return this._payload}get metadata(){return this._metadata}get target(){return this._target}get isCustomEvent(){return!1}payloadToJson(){return this.payload}toJson(){return{payload:this.payloadToJson(),type:this.type,isCustomEvent:this.isCustomEvent}}toString(){return JSON.stringify(this.toJson())}}class Bt extends Lt{constructor(e,t=!1){super(e,"change",{dispatch:t})}withAdditionalChange(e){return new Bt(this.payload.changes.concat(e.payload.changes),this.metadata)}}class Gt extends Lt{constructor(e={}){super(e,"invalid",{})}}class qt extends Lt{constructor(e={}){super(e,"valid",{})}}class zt extends Lt{constructor(e={},t=!1){super(e,"executeRule",{dispatch:t})}}const Vt=(e,t,n)=>new Bt({changes:[{propertyName:e,currentValue:t,prevValue:n}]});class Qt extends Lt{constructor(e,t=!1){super(e,"initialize",{dispatch:t})}}class Jt extends Lt{constructor(){super({},"load",{dispatch:!1})}}class Ht extends Lt{constructor(e,t=!1){super(e,"click",{dispatch:t})}}class Wt extends Lt{constructor(e,t=!1){super(e,"blur",{dispatch:t})}}class Xt extends Lt{constructor(e,t=!1){super(e,"validationComplete",{dispatch:t})}}class Zt extends Lt{constructor(){super({},"focus",{dispatch:!1})}}class en extends Lt{constructor(e,t=!1){super(e,"submit",{dispatch:t})}}class tn extends Lt{constructor(e,t){super({field:t,changes:e},"fieldChanged")}}class nn extends Lt{constructor(e,t={},n=!1){super(t,e,{dispatch:n})}get isCustomEvent(){return!0}}class rn extends Lt{constructor(e){super(e,"addItem")}}class sn extends Lt{constructor(e){super(e,"removeItem")}}class on{constructor(e,t,n=typeof t){this.$_fields=[],this.$_name=e,this.$_value=t,this.$_type=n}valueOf(){return this.$_value}get $name(){return this.$_name}get $value(){return this.$_value}setValue(e,t,n){this.$_value=e,this.$_fields.forEach(e=>{n!==e&&(e.value=t)})}get $type(){return this.$_type}$bindToField(e){-1===this.$_fields.indexOf(e)&&this.$_fields.push(e)}$convertToDataValue(){return this}get $isDataGroup(){return!1}}const an=Symbol("NullValue"),ln=new class extends on{constructor(){super("",an,"null")}setValue(){}$bindToField(){}$length(){return 0}$convertToDataValue(){return this}$addDataNode(){}$removeDataNode(){}$getDataNode(){return this}$containsDataNode(){return!1}};class un extends on{createEntry(e,t){const n=t instanceof Array?"array":typeof t;return"object"==typeof t&&null!=t?new un(e,t,n):new on(e,t,n)}constructor(e,t,n=typeof t){super(e,t,n),this.$_items=t instanceof Array?t.map((e,t)=>this.createEntry(t,e)):Object.fromEntries(Object.entries(t).map(([e,t])=>[e,this.createEntry(e,t)]))}get $value(){return"array"===this.$type?Object.values(this.$_items).filter(e=>void 0!==e).map(e=>e.$value):Object.fromEntries(Object.values(this.$_items).filter(e=>void 0!==e).map(e=>[e.$name,e.$value]))}get $length(){return Object.entries(this.$_items).length}$convertToDataValue(){return new on(this.$name,this.$value,this.$type)}$addDataNode(e,t,n=!1){if(t!==ln)if("array"===this.$type){const r=e;n?this.$_items[e]=t:this.$_items.splice(r,0,t)}else this.$_items[e]=t}$removeDataNode(e){this.$_items[e]=void 0}$getDataNode(e){if(this.$_items.hasOwnProperty(e))return this.$_items[e]}$containsDataNode(e){return this.$_items.hasOwnProperty(e)&&void 0!==this.$_items[e]}get $isDataGroup(){return!0}}const cn=(e,t)=>({type:"Identifier",value:e,start:t}),hn=function(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e},dn=(e,t,n)=>null===e&&"$"===t[n],pn=(e,t)=>{const n=e[t];return"$"===n?e.length>t&&hn(e[t+1]):n>="a"&&n<="z"||n>="A"&&n<="Z"||"_"===n},_n=e=>e>="0"&&e<="9";class fn{constructor(e){this._tokens=[],this._result_tokens=[],this.stream=e,this._current=0}_consumeGlobal(){return this._current+=1,{type:"Global",start:0,value:"$"}}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&hn(e[this._current]);)this._current+=1;return cn(e.slice(t,this._current),t)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const n=e.length;for(;'"'!==e[this._current]&&this._current<n;){let t=this._current;t+="\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?1:2,this._current=t}return this._current+=1,cn(JSON.parse(e.slice(t,this._current)),t)}_consumeNumber(e){const t=this._current;this._current+=1;const n=e.length;for(;_n(e[this._current])&&this._current<n;)this._current+=1;const r=e.slice(t,this._current);return{type:"Number",value:parseInt(r,10),start:t}}_consumeBracket(e){const t=this._current;let n;if(this._current+=1,!_n(e[this._current]))throw new Error(`unexpected exception at position ${this._current}. Must be a character`);if(n=this._consumeNumber(e).value,this._current<this.stream.length&&"]"!==e[this._current])throw new Error(`unexpected exception at position ${this._current}. Must be a character`);return this._current++,((e,t)=>({type:"bracket",value:e,start:t}))(n,t)}tokenize(){const e=this.stream;for(;this._current<e.length;){const t=this._tokens.length?this._tokens.slice(-1)[0]:null;if(dn(t,e,this._current)){const e=this._consumeGlobal();this._tokens.push(e),this._result_tokens.push(e)}else if(pn(e,this._current)){const t=this._consumeUnquotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}else if("."===e[this._current]&&null!=t&&"DOT"!==t.type)this._tokens.push({type:"DOT",value:".",start:this._current}),this._current+=1;else if("["===e[this._current]){const t=this._consumeBracket(e);this._tokens.push(t),this._result_tokens.push(t)}else{if('"'!==e[this._current]){const e=Math.max(0,this._current-2),t=Math.min(this.stream.length,this._current+2);throw new Error(`Exception at parsing stream ${this.stream.slice(e,t)}`)}{const t=this._consumeQuotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}}}return this._result_tokens}}const gn=e=>new fn(e).tokenize(),mn=(e,t,n)=>{let r;r="string"==typeof t?gn(t):t;let s=e,i=0;const o=(e,t,n)=>null===t?n:"bracket"===t.type?new un(e.value,[],"array"):new un(e.value,{});for(;i<r.length&&null!=s;){const t=r[i];if("Global"===t.type)s=e;else if("Identifier"===t.type){if(!(s instanceof un&&"object"===s.$type))throw new Error(`Looking for ${t.value} in ${s.$value}`);if(s.$containsDataNode(t.value)&&null!==s.$getDataNode(t.value).$value)s=s.$getDataNode(t.value);else if(n){const e=o(t,i<r.length-1?r[i+1]:null,n);s.$addDataNode(t.value,e),s=e}else s=void 0}else if("bracket"===t.type){if(!(s instanceof un&&"array"===s.$type))throw new Error(`Looking for index ${t.value} in non array${s.$value}`);{const e=t.value;if(e<s.$length)s=s.$getDataNode(e);else if(n){const a=o(t,i<r.length-1?r[i+1]:null,n);s.$addDataNode(e,a),s=a}else s=void 0}}i+=1}return s};var yn=function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};const vn=["value","label","description","visible","enabled","readOnly","enum","enumNames","required","properties","exclusiveMinimum","exclusiveMaximum","maxLength","maximum","maxItems","minLength","minimum","minItems","step"],En=[...vn,"valid","index","activeChild"];class Tn{constructor(e,t){this._action=e,this._target=t}get type(){return this._action.type}get payload(){return this._action.payload}get metadata(){return this._action.metadata}get target(){return this._target}get isCustomEvent(){return this._action.isCustomEvent}get originalAction(){return this._action.originalAction}toString(){return this._action.toString()}}const bn=Symbol("target"),On=Symbol("qualifiedName");class Nn{get isContainer(){return!1}constructor(e,t){this._callbacks={},this._dependents=[],this._tokens=[],this._options=t,this[On]=null,this._jsonModel=bt({},e,{id:"id"in e?e.id:this.form.getUniqueId()})}setupRuleNode(){const e=this;this._ruleNode=new Proxy(this.ruleNodeReference(),{get:(t,n)=>e.getFromRule(t,n)})}ruleNodeReference(){return this}getRuleNode(){return this._ruleNode}getFromRule(e,t){if(t===Symbol.toPrimitive||"valueOf"===t&&!e.hasOwnProperty("valueOf"))return this.valueOf;if(t===bn)return this;if("string"==typeof t)if(t.startsWith("$")){if("function"!=typeof this[t=t.substr(1)]){const e=this[t];return e instanceof Nn?e.getRuleNode():e instanceof Array?e.map(e=>e instanceof Nn?e.getRuleNode():e):e}}else{if(e.hasOwnProperty(t))return e[t];if("function"==typeof e[t])return e[t]}}get id(){return this._jsonModel.id}get index(){return this.parent.indexOf(this)}get parent(){return this._options.parent}get type(){return this._jsonModel.type}get fieldType(){return this._jsonModel.fieldType||"text-input"}get":type"(){return this._jsonModel[":type"]||this.fieldType}get name(){return this._jsonModel.name}get description(){return this._jsonModel.description}set description(e){this._setProperty("description",e)}get dataRef(){return this._jsonModel.dataRef}get visible(){return this._jsonModel.visible}set visible(e){if(e!==this._jsonModel.visible){const t=Vt("visible",e,this._jsonModel.visible);this._jsonModel.visible=e,this.notifyDependents(t)}}get form(){return this._options.form}get ruleEngine(){return this.form.ruleEngine}get label(){return this._jsonModel.label}set label(e){if(e!==this._jsonModel.label){const t=Vt("label",e,this._jsonModel.label);this._jsonModel=bt({},this._jsonModel,{label:e}),this.notifyDependents(t)}}get uniqueItems(){return this._jsonModel.uniqueItems}isTransparent(){var e;const t="array"===(null==(e=this.parent)?void 0:e._jsonModel.type);return!this._jsonModel.name&&!t}getState(){return bt({},this._jsonModel,{":type":this[":type"]})}subscribe(e,t="change"){return this._callbacks[t]=this._callbacks[t]||[],this._callbacks[t].push(e),{unsubscribe:()=>{this._callbacks[t]=this._callbacks[t].filter(t=>t!==e)}}}_addDependent(e){if(void 0===this._dependents.find(({node:t})=>t===e)){const t=this.subscribe(t=>{const n=[...En,"items"],r=t.payload.changes.findIndex(e=>n.indexOf(e.propertyName)>-1)>-1;r&&e.dispatch(new zt)});this._dependents.push({node:e,subscription:t})}}removeDependent(e){const t=this._dependents.findIndex(({node:t})=>t===e);t>-1&&(this._dependents[t].subscription.unsubscribe(),this._dependents.splice(t,1))}queueEvent(e){const t=new Tn(e,this);this.form.getEventQueue().queue(this,t,["valid","invalid"].indexOf(t.type)>-1)}dispatch(e){this.queueEvent(e),this.form.getEventQueue().runPendingQueue()}notifyDependents(e){(this._callbacks[e.type]||[]).forEach(t=>{t(new Tn(e,this))})}_setProperty(e,t,n=!0){const r=this._jsonModel[e];let s=!1;if(s=null!==t&&null!==r&&"object"==typeof t&&"object"==typeof r?JSON.stringify(t)===JSON.stringify(r):r===t,!s){this._jsonModel[e]=t;const s=Vt(e,t,r);return n&&this.notifyDependents(s),s.payload.changes}return[]}_bindToDataModel(e){if("$form"===this.id)return void(this._data=e);const t=this._jsonModel.dataRef;let n,r=e,s="";if(null===t)n=ln;else if(void 0!==t){0===this._tokens.length&&(this._tokens=gn(t));let i=e;if("Global"===this._tokens[0].type&&(i=this.form.getDataNode()),void 0!==i){const e=this._tokens[this._tokens.length-1].value,t=this.defaultDataModel(e);n=mn(i,this._tokens,t),r=mn(i,this._tokens.slice(0,-1)),s=e}}else if(e!==ln){r=e;const t=this._jsonModel.name||"",i="array"===e.$type?this.index:t;if(s=i,""!==i){const t=this.defaultDataModel(i);void 0!==t&&(n=e.$getDataNode(i),void 0===n&&(n=t,e.$addDataNode(i,n)))}else n=void 0}var i,o;n&&(this.isContainer||r===ln||n===ln||(n=null==(o=n)?void 0:o.$convertToDataValue(),r.$addDataNode(s,n,!0)),null==(i=n)||i.$bindToField(this),this._data=n)}getDataNode(){return this._data}get properties(){return this._jsonModel.properties||{}}set properties(e){this._setProperty("properties",bt({},e))}getNonTransparentParent(){let e=this.parent;for(;null!=e&&e.isTransparent();)e=e.parent;return e}_initialize(){if(void 0===this._data){let e,t=this.parent;do{e=t.getDataNode(),t=t.parent}while(void 0===e);this._bindToDataModel(e)}}_applyUpdates(e,t){return e.reduce((e,n)=>{const r=this._setProperty(n,t[n],!1);return r.length>0&&(e[n]=r[0]),e},{})}get qualifiedName(){if(this.isTransparent())return null;if(null!==this[On])return this[On];const e=this.getNonTransparentParent();return this[On]=e&&"array"===e.type?`${e.qualifiedName}[${this.index}]`:`${e.qualifiedName}.${this.name}`,this[On]}focus(){this.parent&&(this.parent.activeChild=this)}}yn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Nn.prototype,"index",null),yn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Nn.prototype,"description",null),yn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Nn.prototype,"visible",null),yn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Nn.prototype,"label",null),yn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Nn.prototype,"properties",null);class Mn extends Nn{constructor(...e){super(...e),this._events={},this._rules={}}get rules(){return this._jsonModel.rules||{}}getCompiledRule(e,t){if(!(e in this._rules)){const n=t||this.rules[e];if(!("string"==typeof n&&n.length>0))throw new Error(`only expression strings are supported. ${typeof n} types are not supported`);try{this._rules[e]=this.ruleEngine.compileRule(n)}catch(t){this.form.logger.error(`Unable to compile rule \`"${e}" : "${n}"\` Exception : ${t}`)}}return this._rules[e]}getCompiledEvent(e){if(!(e in this._events)){var t;let n=null==(t=this._jsonModel.events)?void 0:t[e];"string"==typeof n&&n.length>0&&(n=[n]),void 0!==n&&n.length>0&&(this._events[e]=n.map(t=>{try{return this.ruleEngine.compileRule(t)}catch(t){this.form.logger.error(`Unable to compile expression \`"${e}" : "${n}"\` Exception : ${t}`)}return null}).filter(e=>null!==e))}return this._events[e]||[]}applyUpdates(e){Object.entries(e).forEach(([e,t])=>{if(e in vn||e in this&&"function"!=typeof this[e])try{this[e]=t}catch(e){console.error(e)}})}executeAllRules(e){const t=Object.entries(this.rules);if(t.length>0){const n=this.getExpressionScope();t.forEach(([t,r])=>{const s=this.getCompiledRule(t,r);if(s){const r=this.ruleEngine.execute(s,n,e,!0);vn.indexOf(t)>-1?this[t]=r:this.form.logger.warn(`${t} is not a valid editable property.`)}})}}getExpressionScope(){const e=this.getNonTransparentParent(),t={self:this.getRuleNode(),siblings:(null==e?void 0:e.ruleNodeReference())||{}},n=new Proxy(t,{get:(e,t)=>{if(t===Symbol.toStringTag)return"Object";if(t.startsWith("$")){const n=e.self[t];return n instanceof Nn?n.getRuleNode():n instanceof Array?n.map(e=>e instanceof Nn?e.getRuleNode():e):n}return t in e.siblings?e.siblings[t]:e.self[t]},has:(e,t)=>void 0!==e.self[t]||void 0!==e.siblings[t]});return n}executeEvent(e,t){let n;t&&(n=this.ruleEngine.execute(t,this.getExpressionScope(),e)),void 0!==n&&null!=n&&this.applyUpdates(n)}executeRule(e,t){void 0===e.payload.ruleName&&this.executeAllRules(t)}executeExpression(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this},n=this.ruleEngine.compileRule(e);return this.ruleEngine.execute(n,this.getExpressionScope(),t)}executeAction(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this,$event:{type:e.type,payload:e.payload,target:this.getRuleNode()}},n=e.isCustomEvent?`custom_${e.type}`:e.type;this.getCompiledEvent(e.isCustomEvent?`custom:${e.type}`:e.type).forEach(e=>this.executeEvent(t,e)),n in this&&"function"==typeof this[n]&&this[n](e,t),this.notifyDependents(e)}}var Rn=function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};class xn extends Mn{constructor(...e){super(...e),this._children=[],this._itemTemplate=null,this._activeChild=null}ruleNodeReference(){return this._childrenReference}get items(){return this._children}get maxItems(){return this._jsonModel.maxItems}set maxItems(e){this._jsonModel.maxItems=e;const t=this._children.length,n=Math.min(t-e,t-(this._jsonModel.minItems||1));if(n>0){for(let t=0;t<n;t++)this.getDataNode().$removeDataNode(e+t),this._childrenReference.pop();const t=this._children.splice(e,n);this.notifyDependents(Vt("items",t,null))}}get minItems(){return this._jsonModel.minItems}hasDynamicItems(){return null!=this._itemTemplate}get isContainer(){return!0}getState(){return bt({},this._jsonModel,{":type":this[":type"],items:this._children.map(e=>bt({},e.getState()))})}_addChildToRuleNode(e,t){const n=this,{parent:r=this}=t,s="array"==r.type?r._children.length+"":e.name||"";s.length>0&&Object.defineProperty(r._childrenReference,s,{get:()=>(e.isContainer&&e.hasDynamicItems()&&n.ruleEngine.trackDependency(e),n.hasDynamicItems()?(n.ruleEngine.trackDependency(n),void 0!==this._children[s]?this._children[s].getRuleNode():void 0):e.getRuleNode()),configurable:!0,enumerable:!0})}_addChild(e,t,n=!1){let r=this;for(;null!=r&&r.isTransparent();)r=r.parent;("number"!=typeof t||t>r._children.length)&&(t=this._children.length);const s=this.form,i=bt({index:t},Ut(e,n?()=>s.getUniqueId():void 0)),o=this._createChild(i,{parent:this,index:t});return this._addChildToRuleNode(o,{parent:r}),t===this._children.length?this._children.push(o):this._children.splice(t,0,o),o}indexOf(e){return this._children.indexOf(e)}defaultDataModel(e){const t=this._jsonModel.type||void 0;if(void 0!==t)return new un(e,"array"===t?[]:{},t)}_initialize(){super._initialize();const e=this._jsonModel.items;if(this._jsonModel.items=[],this._childrenReference="array"==this._jsonModel.type?[]:{},"array"==this._jsonModel.type&&1===e.length&&null!=this.getDataNode()){this._itemTemplate=Ut(e[0]),"number"!=typeof this._jsonModel.minItems&&(this._jsonModel.minItems=0),"number"!=typeof this._jsonModel.maxItems&&(this._jsonModel.maxItems=-1),"number"!=typeof this._jsonModel.initialItems&&(this._jsonModel.initialItems=Math.max(1,this._jsonModel.minItems));for(let e=0;e<this._jsonModel.initialItems;e++)this._addChild(this._itemTemplate)._initialize()}else e.length>0&&(e.forEach(e=>{this._addChild(e)._initialize()}),this._jsonModel.minItems=this._children.length,this._jsonModel.maxItems=this._children.length,this._jsonModel.initialItems=this._children.length);this.setupRuleNode()}addItem(e){if("addItem"===e.type&&null!=this._itemTemplate&&(-1===this._jsonModel.maxItems||this._children.length<this._jsonModel.maxItems)){const t=this.getDataNode();let n=e.payload;("number"!=typeof n||n>this._children.length)&&(n=this._children.length);const r=this._addChild(this._itemTemplate,e.payload,!0),s=r.defaultDataModel(n);s&&t.$addDataNode(n,s),r._initialize(),this.notifyDependents(Vt("items",r.getState,null)),r.dispatch(new Qt),r.dispatch(new zt);for(let e=n+1;e<this._children.length;e++)this._children[e].dispatch(new zt)}}removeItem(e){if("removeItem"===e.type&&null!=this._itemTemplate){if(0==this._children.length)return;const t="number"==typeof e.payload?e.payload:this._children.length-1,n=this._children[t].getState();if(this._children.length>this._jsonModel.minItems){this._childrenReference.pop(),this._children.splice(t,1),this.getDataNode().$removeDataNode(t);for(let e=t;e<this._children.length;e++)this._children[e].dispatch(new zt);this.notifyDependents(Vt("items",null,n))}}}queueEvent(e){var t;super.queueEvent(e),null!=(t=e.metadata)&&t.dispatch&&this.items.forEach(t=>{t.queueEvent(e)})}validate(){return this.items.flatMap(e=>e.validate()).filter(e=>""!==e.fieldName)}dispatch(e){super.dispatch(e)}importData(e){this._bindToDataModel(e);const t=this.getDataNode()||e;this.syncDataAndFormModel(t)}syncDataAndFormModel(e){if("array"===(null==e?void 0:e.$type)&&null!=this._itemTemplate){const t=null==e?void 0:e.$value.length,n=this._children.length,r=this._jsonModel.minItems;let s=Math.min(t-n,(-1===this._jsonModel.maxItems?t:this._jsonModel.maxItems)-n);const i=Math.min(n-t,n-r);for(;s>0;)s--,this._addChild(this._itemTemplate)._initialize();if(i>0){this._children.splice(t,i);for(let e=0;e<i;e++)this._childrenReference.pop()}}this._children.forEach(t=>{t.importData(e)})}get activeChild(){return this._activeChild}set activeChild(e){if(e!==this._activeChild){let t=this._activeChild;for(;t instanceof xn;){const e=t.activeChild;t.activeChild=null,t=e}const n=Vt("activeChild",e,this._activeChild);this._activeChild=e,this.parent&&null!==e&&(this.parent.activeChild=this),this._jsonModel.activeChild=null==e?void 0:e.id,this.notifyDependents(n)}}}Rn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],xn.prototype,"maxItems",null),Rn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],xn.prototype,"minItems",null),Rn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],xn.prototype,"activeChild",null);class jn{constructor(e){this._jsonModel=bt({},e)}getP(e,t){return Dt(this._jsonModel,e,t)}get isContainer(){return!1}}class Pn extends jn{get version(){return this.getP("version","")}get locale(){return this.getP("locale","")}get grammar(){return this.getP("grammar","")}}class wn{constructor(e){this.type="application/octet-stream",this.name="unknown",this.size=0,Object.assign(this,e)}toJSON(){return{name:this.name,size:this.size,type:this.type,data:this.data.toString()}}equals(e){return this.data===e.data&&this.type===e.type&&this.name===e.name&&this.size===e.size}}const $n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_".split(""),In=/^(\d*\.?\d+)(\\?(?=[KMGT])([KMGT])(?:i?B)?|B?)$/i,Dn=e=>{const t=[];for(let n=0;n<=e;n++){const e=Math.floor(Math.random()*$n.length);t.push($n[e])}return t.join("")},An=e=>{const t=e.items||[];return null==t?void 0:t.reduce((e,t)=>{let n=null;if(t.isContainer)n=An(t);else if(At(t.getState())){n={};const e=t.name||"",r=null!=t.dataRef?t.dataRef:e.length>0?t.name:void 0;t.value instanceof Array?n[t.id]=t.value.map(e=>bt({},e,{dataRef:r})):null!=t.value&&(n[t.id]=bt({},t.value,{dataRef:r}))}return Object.assign(e,n)},{})},Sn=e=>{let t=0;if("string"==typeof e){const n=In.exec(e.trim());null!=n&&(t=Yn(parseFloat(n[1]),(n[2]||"kb").toUpperCase()))}return t},Yn=(e,t)=>{const n=Math.pow(1024,{KB:1,MB:2,GB:3,TB:4}[t]);return Math.round(e*n)},kn=e=>{if(null!==e){let c=null;if(e instanceof wn)c=e;else if("undefined"!=typeof File&&e instanceof File)c={name:e.name,type:e.type,size:e.size,data:e};else if("string"==typeof e&&Ln(e)){const t=Cn(e);if(null!==t){const{blob:e,name:n}=t;c={name:n,type:e.type,size:e.size,data:e}}}else{var t,n;let h=e;try{h=JSON.parse(e),c=h}catch(e){}if("string"==typeof(null==(t=h)?void 0:t.data)&&Ln(null==(n=h)?void 0:n.data)){var r;const e=Cn(null==(r=h)?void 0:r.data);if(null!==e){var s,i;const t=e.blob;c={name:null==(s=h)?void 0:s.name,type:null==(i=h)?void 0:i.type,size:t.size,data:t}}}else if("string"==typeof h)c={name:h.split("/").pop(),type:"application/octet-stream",size:0,data:h};else if("object"==typeof h){var o,a,l,u;c={name:null==(o=h)?void 0:o.name,type:null==(a=h)?void 0:a.type,size:null==(l=h)?void 0:l.size,data:null==(u=h)?void 0:u.data}}}return null!==c&&null!=c.data?new wn(c):null}return null},Cn=e=>{const t=/^data:([a-z]+\/[a-z0-9-+.]+)?(?:;name=([^;]+))?(;base64)?,(.+)$/.exec(e);if(null!==t){const e=t[1]||"",n=t[2]||"unknown";if("string"==typeof t[3]){const r=atob(t[4]),s=[];for(let e=0;e<r.length;e++)s.push(r.charCodeAt(e));return{name:n,blob:new window.Blob([new Uint8Array(s)],{type:e})}}return{name:n,blob:new window.Blob([t[4]],{type:e})}}return null},Un=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,Kn=/^data:([a-z]+\/[a-z0-9-+.]+)?;(?:name=(.*);)?base64,(.*)$/,Fn=[31,28,31,30,31,30,31,31,30,31,30,31],Ln=e=>null!=Kn.exec(e.trim()),Bn=e=>{let t=parseFloat(e);const n=!isNaN(t);return n||(t=e),{value:t,valid:n}},Gn=e=>{let t=parseFloat(e);const n=!isNaN(t)&&Math.round(t)===t;return n||(t=e),{value:t,valid:n}},qn=e=>null==e||e instanceof Array?e:[e],zn=e=>{const t="boolean"==typeof e||"true"===e||"false"===e;return{valid:t,value:"boolean"==typeof e?e:t?"true"===e:e}},Vn=e=>{const t=kn(e),n=null!==t;return{value:n?t:e,valid:n}},Qn=(e,t)=>{const n=qn(e);return null==n?[[],[n]]:n.reduce((e,n)=>{if(0==e[1].length){const r=t(n);e[r.valid?0:1].push(r.value)}return e},[[],[]])},Jn={date:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","format"],string:["minLength","maxLength","pattern"],number:["minimum","maximum","exclusiveMinimum","exclusiveMaximum"],array:["minItems","maxItems","uniqueItems"],file:["accept","maxFileSize"]},Hn={type:(e,t)=>{let n=t;if(null==t)return{valid:!0,value:t};let r,s=!0;switch(e){case"string":s=!0,n=t.toString();break;case"string[]":n=qn(t);break;case"number":r=Bn(t),n=r.value,s=r.valid;break;case"boolean":r=zn(t),s=r.valid,n=r.value;break;case"integer":r=Gn(t),s=r.valid,n=r.value;break;case"integer[]":r=Qn(t,Gn),s=0===r[1].length,n=s?r[0]:t;break;case"file":r=Vn(t instanceof Array?t[0]:t),s=r.valid,n=r.value;break;case"file[]":r=Qn(t,Vn),s=0===r[1].length,n=s?r[0]:t;break;case"number[]":r=Qn(t,Bn),s=0===r[1].length,n=s?r[0]:t;break;case"boolean[]":r=Qn(t,zn),s=0===r[1].length,n=s?r[0]:t}return{valid:s,value:n}},format:(e,t)=>{let n=!0;const r=t;if(null===t)return{value:r,valid:n};let s;switch(e){case"date":if(s=Un.exec((t||"").trim()),null!=s){const[e,t,r,i]=s,[o,a]=[+r,+i],l=(e=>e%400==0||e%4==0&&e%100!=0)(+t);n=o>=1&&o<=12&&a>=1&&a<=((e,t)=>e&&2==t?29:Fn[t-1])(l,o)}else n=!1;break;case"data-url":n=!0}return{valid:n,value:r}},minimum:(e,t)=>({valid:t>=e,value:t}),maximum:(e,t)=>({valid:t<=e,value:t}),exclusiveMinimum:(e,t)=>({valid:t>e,value:t}),exclusiveMaximum:(e,t)=>({valid:t<e,value:t}),minItems:(e,t)=>({valid:t instanceof Array&&t.length>=e,value:t}),maxItems:(e,t)=>({valid:t instanceof Array&&t.length<=e,value:t}),uniqueItems:(e,t)=>({valid:!e||t instanceof Array&&t.length===new Set(t).size,value:t}),minLength:(e,t)=>bt({},Hn.minimum(e,"string"==typeof t?t.length:0),{value:t}),maxLength:(e,t)=>bt({},Hn.maximum(e,"string"==typeof t?t.length:0),{value:t}),pattern:(e,t)=>{let n;return n="string"==typeof e?new RegExp(e):e,{valid:n.test(t),value:t}},required:(e,t)=>({valid:!e||null!=t&&""!==t,value:t}),enum:(e,t)=>({valid:e.indexOf(t)>-1,value:t}),accept:(e,t)=>e&&0!==e.length&&null!=t?{valid:!(t instanceof Array?t:[t]).some(t=>{return!(!(n=t.type)||e.some(e=>{const t=e.trim(),r=t.split("/")[0],s=t.split(".")[1];return t.includes("*")&&n.startsWith(r)||t.includes(".")&&n.endsWith(s)||t===n}));var n}),value:t}:{valid:!0,value:t},maxFileSize:(e,t)=>{const n="string"==typeof e?Sn(e):e;return{valid:!(t instanceof wn)||t.size<=n,value:t}}};var Wn=function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};class Xn extends Mn{constructor(e,t){super(e,t),this._ruleNodeReference=[],this._applyDefaults(),this.queueEvent(new Qt),this.queueEvent(new zt)}_initialize(){super._initialize(),this.setupRuleNode()}ruleNodeReference(){var e;return this._ruleNodeReference=null!=(e=this.type)&&e.endsWith("[]")?[]:this,this._ruleNodeReference}_getDefaults(){return{readOnly:!1,enabled:!0,visible:!0,type:this._getFallbackType()}}_getFallbackType(){if("string"!=typeof this._jsonModel.type){const e=this.enum;return e&&e.length>0?typeof e[0]:"string"}}_applyDefaults(){if(Object.entries(this._getDefaults()).map(([e,t])=>{void 0===this._jsonModel[e]&&void 0!==t&&(this._jsonModel[e]=t)}),void 0===this._jsonModel.value){const e=Hn.type(this.getInternalType()||"string",this._jsonModel.default);this._jsonModel.value=e.value}void 0===this._jsonModel.fieldType&&(this._jsonModel.viewType?(this._jsonModel.viewType.startsWith("custom:")?this.form.logger.error("viewType property has been removed. For custom types, use :type property"):this.form.logger.error("viewType property has been removed. Use fieldType property"),this._jsonModel.fieldType=this._jsonModel.viewType):this._jsonModel.fieldType=wt(this._jsonModel)),void 0===this._jsonModel.enum&&"boolean"===this._jsonModel.type&&(this._jsonModel.enum=[!0,!1]),"number"==typeof this._jsonModel.step&&"number"===this._jsonModel.type||(this._jsonModel.step=void 0)}get editFormat(){return this._jsonModel.editFormat}get displayFormat(){return this._jsonModel.displayFormat}get placeholder(){return this._jsonModel.placeholder}get readOnly(){return this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e)}get language(){return Intl.DateTimeFormat().resolvedOptions().locale}get enabled(){return this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e)}get valid(){return this._jsonModel.valid}get emptyValue(){return"null"===this._jsonModel.emptyValue?null:""===this._jsonModel.emptyValue&&"string"===this.type?"":void 0}get enum(){return this._jsonModel.enum}set enum(e){this._setProperty("enum",e)}get enumNames(){return this._jsonModel.enumNames}set enumNames(e){this._setProperty("enumNames",e)}get required(){return this._jsonModel.required||!1}set required(e){this._setProperty("required",e)}get maximum(){return this._jsonModel.maximum}set maximum(e){this._setProperty("maximum",e)}get minimum(){return this._jsonModel.minimum}set minimum(e){this._setProperty("minimum",e)}isEmpty(){return null==this._jsonModel.value||""===this._jsonModel.value}get editValue(){const e=this.editFormat;return"date"==this.format&&null!=this.value&&!1!==this.valid?formatDate(new Date(this.value),this.language,e):this.value}get displayValue(){const e=this.displayFormat;return"date"==this.format&&null!=this.value&&!1!==this.valid?formatDate(new Date(this.value),this.language,e):this.value}getDataNodeValue(e){return this.isEmpty()?this.emptyValue:e}get value(){return void 0===this._jsonModel.value?null:this._jsonModel.value}set value(e){const t=this._getConstraintObject(),n=t.type(this.getInternalType()||"string",e),r=this._setProperty("value",n.value,!1);let s={valid:!0};if(r.length>0){this._updateRuleNodeReference(n.value);const e=this.getDataNode();let i;if(void 0!==e&&e.setValue(this.getDataNodeValue(this._jsonModel.value),this._jsonModel.value,this),this.parent.uniqueItems&&"array"===this.parent.type&&(s=t.uniqueItems(this.parent.uniqueItems,this.parent.getDataNode().$value)),n.valid&&s.valid)i=this.evaluateConstraints();else{const e={valid:n.valid&&s.valid,errorMessage:n.valid&&s.valid?"":this.getErrorMessage("type")};i=this._applyUpdates(["valid","errorMessage"],e)}i.valid&&this.triggerValidationEvent(i);const o=new Bt({changes:r.concat(Object.values(i))});this.dispatch(o)}}_updateRuleNodeReference(e){var t;if(null!=(t=this.type)&&t.endsWith("[]"))if(null!=e)for(e.forEach((e,t)=>{this._ruleNodeReference[t]=e});e.length!==this._ruleNodeReference.length;)this._ruleNodeReference.pop();else for(;0!==this._ruleNodeReference.length;)this._ruleNodeReference.pop()}getInternalType(){return this.type}valueOf(){const e=this[bn],t=void 0===e?this:e;return t.ruleEngine.trackDependency(t),t._jsonModel.value||null}toString(){var e;const t=this[bn];return(null==(e=(void 0===t?this:t)._jsonModel.value)?void 0:e.toString())||""}getErrorMessage(e){var t;return(null==(t=this._jsonModel.constraintMessages)?void 0:t[e])||""}_getConstraintObject(){return Hn}isArrayType(){return!!this.type&&this.type.indexOf("[]")>-1}checkEnum(e,t){if(!0===this._jsonModel.enforceEnum&&null!=e){const n=t.enum;return e instanceof Array&&this.isArrayType()?e.every(e=>n(this.enum||[],e).valid):n(this.enum||[],e).valid}return!0}checkStep(){return"number"!=typeof this._jsonModel.step||(this._jsonModel.value-(this._jsonModel.minimum||this._jsonModel.default||0))%this._jsonModel.step==0}checkValidationExpression(){return"string"!=typeof this._jsonModel.validationExpression||this.executeExpression(this._jsonModel.validationExpression)}getConstraints(){switch(this.type){case"string":switch(this.format){case"date":return Jn.date;case"binary":case"data-url":return Jn.file;default:return Jn.string}case"file":return Jn.file;case"number":case"integer":return Jn.number}return this.isArrayType()?Jn.array:[]}get format(){return this._jsonModel.format||""}evaluateConstraints(){let e="type";const t=this._jsonModel,n=this._jsonModel.value,r=this._getConstraintObject(),s=this.getConstraints();let i=!0;if(i&&(i=r.required(this.required,n).valid&&(!this.isArrayType()||!this.required||n.length>0),e="required"),i&&n!=this.emptyValue){const o=s.find(e=>{if(e in t){const s=t[e],i=r[e];return n instanceof Array&&this.isArrayType()?-1!==Jn.array.indexOf(e)?!i(s,n).valid:n.some(e=>!i(s,e).valid):"function"==typeof i&&!i(s,n).valid}return!1});null!=o?(i=!1,e=o):(i=this.checkEnum(n,r),e="enum",i&&"number"===this.type&&(i=this.checkStep(),e="step"),i&&(i=this.checkValidationExpression(),e="validationExpression"))}i||this.form.logger.log(`${e} constraint evaluation failed ${this[e]}. Received ${this._jsonModel.value}`);const o={valid:i,errorMessage:i?"":this.getErrorMessage(e)};return this._applyUpdates(["valid","errorMessage"],o)}triggerValidationEvent(e){e.valid&&this.dispatch(this.valid?new qt:new Gt)}validate(){const e=this.evaluateConstraints();return e.valid&&(this.triggerValidationEvent(e),this.notifyDependents(new Bt({changes:Object.values(e)}))),this.valid?[]:[new Mt(this.id,[this._jsonModel.errorMessage])]}importData(e){this._bindToDataModel(e);const t=this.getDataNode();if(void 0!==t&&t!==ln&&t.$value!==this._jsonModel.value){const e=Vt("value",t.$value,this._jsonModel.value);this._jsonModel.value=t.$value,this.queueEvent(e)}}defaultDataModel(e){return new on(e,this.getDataNodeValue(this._jsonModel.value),this.type||"string")}getState(){return bt({},super.getState(),{editValue:this.editValue,displayValue:this.displayValue})}}function Zn(e,t){return e.replace(";base64",`;name=${encodeURIComponent(t)};base64`)}async function er(e){const{name:t,size:n,type:r}=e;return await new Promise((s,i)=>{const o=new FileReader;o.onload=e=>{s(new wn({data:Zn(e.target.result,t),type:r,name:t,size:n}))},o.readAsDataURL(e.data)})}Wn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Xn.prototype,"readOnly",null),Wn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Xn.prototype,"enabled",null),Wn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Xn.prototype,"valid",null),Wn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Xn.prototype,"enum",null),Wn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Xn.prototype,"enumNames",null),Wn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Xn.prototype,"required",null),Wn([function(e,t,n){const r=n.get;null!=r&&(n.get=function(){return this.ruleEngine.trackDependency(this),r.call(this)})}],Xn.prototype,"value",null);class tr extends Xn{_getDefaults(){return bt({},super._getDefaults(),{accept:["audio/*","video/*","image/*","text/*","application/pdf"],maxFileSize:"2MB",type:"file"})}get maxFileSize(){return Sn(this._jsonModel.maxFileSize)}get accept(){return this._jsonModel.accept}_applyUpdates(e,t){return e.reduce((e,n)=>{const r=this._jsonModel[n],s=t[n];return s!==r&&(e[n]={propertyName:n,currentValue:s,prevValue:r},this._jsonModel[n]=r instanceof wn&&"object"==typeof s&&"value"===n?new wn(bt({},r,{data:s.data})):s),e},{})}getInternalType(){var e;return null!=(e=this.type)&&e.endsWith("[]")?"file[]":"file"}getDataNodeValue(e){let t=e;var n;return null!=t&&("string"===this.type?t=null==(n=t.data)?void 0:n.toString():"string[]"===this.type&&(t=t instanceof Array?t:[t],t=t.map(e=>{var t;return null==e||null==(t=e.data)?void 0:t.toString()}))),t}async _serialize(){const e=this._jsonModel.value;return void 0===e?null:await(t=e instanceof Array?e:[e],Promise.all([].map.call(t,er)));var t}importData(e){this._bindToDataModel(e);const t=this.getDataNode();if(void 0!==t){const e=null==t?void 0:t.$value;if(null!=e){const t=Hn.type(this.getInternalType(),e);t.valid||this.form.logger.error(`unable to bind ${this.name} to data`),this.form.getEventQueue().queue(this,Vt("value",t.value,this._jsonModel.value)),this._jsonModel.value=t.value}else this._jsonModel.value=null}}}class nr extends Xn{offValue(){const e=this.enum;return e.length>1?e[1]:null}_getConstraintObject(){const e=bt({},super._getConstraintObject());var t;return e.required=(t=this.offValue(),(e,n)=>({valid:Hn.required(e,n).valid&&(!e||n!=t),value:n})),e}_getDefaults(){return bt({},super._getDefaults(),{enforceEnum:!0})}get enum(){return this._jsonModel.enum||[]}}class rr extends Xn{constructor(e,t){super(e,t)}_getFallbackType(){const e=super._getFallbackType();if("string"==typeof e)return`${e}[]`}_getDefaults(){return bt({},super._getDefaults(),{enforceEnum:!0,enum:[]})}}class sr extends Xn{_applyDefaults(){super._applyDefaults();const e=(new Intl.DateTimeFormat).resolvedOptions().locale;this._jsonModel.editFormat||(this._jsonModel.editFormat="short"),this._jsonModel.displayFormat||(this._jsonModel.displayFormat=this._jsonModel.editFormat),this._jsonModel.placeholder||(this._jsonModel.placeholder=getSkeleton(this._jsonModel.editFormat,e)),this._jsonModel.description||(this._jsonModel.description=`To enter today's date use ${formatDate(new Date,e,this._jsonModel.editFormat)}`)}}const ir=(e,t)=>{let n;return n="items"in e?new ar(e,t):At(e)||"file-input"===e.fieldType?new tr(e,t):Yt(e)?new nr(e,t):kt(e)?new rr(e,t):Ct(e)?new sr(e,t):new Xn(e,t),t.form.fieldAdded(n),n},or={visible:!0};class ar extends xn{constructor(e,t){super(e,t),this._applyDefaults(),this.queueEvent(new Qt),this.queueEvent(new zt)}_applyDefaults(){Object.entries(or).map(([e,t])=>{void 0===this._jsonModel[e]&&(this._jsonModel[e]=t)}),this._jsonModel.dataRef&&void 0===this._jsonModel.type&&(this._jsonModel.type="object")}get type(){const e=super.type;if("array"===e||"object"===e)return e}_createChild(e,t){const{parent:n=this}=t;return ir(e,{form:this.form,parent:n})}get items(){return super.items}get value(){return null}get fieldType(){return"panel"}get enabled(){return this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e)}}const lr={off:0,debug:1,info:2,warn:3,error:4};class ur{debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e){this.log(e,"error")}log(e,t){0!==this.logLevel&&this.logLevel<=lr[t]&&console[t](e)}constructor(e="off"){this.logLevel=lr[e]}}class cr{constructor(e,t){this._node=e,this._event=t}get node(){return this._node}get event(){return this._event}isEqual(e){return null!=e&&this._node==e._node&&this._event.type==e._event.type}toString(){return this._node.id+"__"+this.event.type}valueOf(){return this.toString()}}class hr{constructor(e=new ur("off")){this._isProcessing=!1,this._pendingEvents=[],this.logger=e,this._runningEventCount={}}get length(){return this._pendingEvents.length}get isProcessing(){return this._isProcessing}isQueued(e,t){const n=new cr(e,t);return void 0!==this._pendingEvents.find(e=>n.isEqual(e))}queue(e,t,n=!1){e&&t&&(t instanceof Array||(t=[t]),t.forEach(t=>{const r=new cr(e,t),s=this._runningEventCount[r.valueOf()]||0;s<hr.MAX_EVENT_CYCLE_COUNT?(this.logger.info(`Queued event : ${t.type} node: ${e.id} - ${e.name}`),n?this._pendingEvents.splice(this._isProcessing?1:0,0,r):this._pendingEvents.push(r),this._runningEventCount[r.valueOf()]=s+1):this.logger.info(`Skipped queueing event : ${t.type} node: ${e.id} - ${e.name} with count=${s}`)}))}runPendingQueue(){if(!this._isProcessing){for(this._isProcessing=!0;this._pendingEvents.length>0;){const e=this._pendingEvents[0];this.logger.info(`Dequeued event : ${e.event.type} node: ${e.node.id} - ${e.node.name}`),e.node.executeAction(e.event),this._pendingEvents.shift()}this._runningEventCount={},this._isProcessing=!1}}}hr.MAX_EVENT_CYCLE_COUNT=10;const dr=(e,t=null,n={})=>{const r=bt({},pr,n);return fetch(e,bt({},r,{body:t})).then(e=>{var t;if(!e.ok)throw new Error(e.statusText);return null!=e&&null!=(t=e.headers.get("Content-Type"))&&t.includes("application/json")?e.json():e.text()})},pr={method:"GET"},_r=e=>{const t=e;return t.length>0&&t.startsWith("custom:")?t.substring("custom:".length):t},fr=async(e,t,n,r,s,i,o)=>{const a=t,l={method:n};let u,c;try{if(r&&r instanceof wn&&r.data instanceof File){const e=new FormData;e.append(r.name,r.data),c=e}else if(r instanceof FormData)c=r;else if(r&&"object"==typeof r&&Object.keys(r).length>0){var h;const e=Object.keys(o);l.headers=e.length>0?bt({},o,-1===e.indexOf("Content-Type")?{"Content-Type":"application/json"}:{}):{"Content-Type":"application/json"};const t=(null==l||null==(h=l.headers)?void 0:h["Content-Type"])||"application/json";"application/json"===t?c=JSON.stringify(r):t.indexOf("multipart/form-data")>-1?c=mr(r):t.indexOf("application/x-www-form-urlencoded")>-1&&(c=gr(r))}u=await dr(a,c,l)}catch(t){e.form.logger.error("Error invoking a rest API");const n=_r(i);return void e.form.dispatch(new nn(n,{},!0))}const d=_r(s);e.form.dispatch(new nn(d,u,!0))},gr=e=>{const t=new URLSearchParams;return Object.entries(e).forEach(([e,n])=>{t.append(e,null!=n&&"object"==typeof n?Ft(n):n)}),t},mr=(e,t)=>{const n=new FormData;Object.entries(e).forEach(([e,t])=>{n.append(e,null!=t&&"object"==typeof t?Ft(t):t)});const r=(e,t)=>{if((null==e?void 0:e.data)instanceof File){let n=`${null==e?void 0:e.dataRef}/${null==e?void 0:e.name}`;n.startsWith("/")||(n=`/${n}`),t.append(n,e.data)}};return t&&Object.keys(t).reduce((e,s)=>{const i=t[s];return i&&i instanceof Array?[...e,...i.map(e=>r(e,n))]:[...e,r(i,n)]},[]),n},yr=new class{constructor(){this.customFunctions={}}registerFunctions(e){Object.entries(e).forEach(([e,t])=>{let n=t;"function"==typeof t&&(n={_func:e=>t(...e),_signature:[]}),n.hasOwnProperty("_func")?this.customFunctions[e]=n:console.warn(`Unable to register function with name ${e}.`)})}unregisterFunctions(...e){e.forEach(e=>{e in this.customFunctions&&delete this.customFunctions[e]})}getFunctions(){function e(t){return null==t?t:null!==(n=t)&&"[object Array]"===Object.prototype.toString.call(n)?t.map(t=>e(t)):t.valueOf();var n}function t(e){return null==e?"":e.toString()}return bt({},{validate:{_func:(e,t,n)=>{const r=e[0];let s;return s="string"==typeof r||void 0===r?n.globals.form.validate():n.globals.form.getElement(r.$id).validate(),Array.isArray(s)&&s.length&&n.globals.form.logger.error("Form Validation Error"),s},_signature:[]},setFocus:{_func:(e,t,n)=>{const r=e[0];try{const e=n.globals.form.getElement(r.$id);n.globals.form.setFocus(e)}catch(e){n.globals.form.logger.error("Invalid argument passed in setFocus. An element is expected")}},_signature:[]},getData:{_func:(e,t,n)=>(n.globals.form.logger.warn("The `getData` function is depricated. Use `exportData` instead."),n.globals.form.exportData()),_signature:[]},exportData:{_func:(e,t,n)=>n.globals.form.exportData(),_signature:[]},importData:{_func:(e,t,n)=>{const r=e[0];return"object"==typeof r&&null!==r&&n.globals.form.importData(r),{}},_signature:[]},submitForm:{_func:(n,r,s)=>{const i=t(n[0]),o=t(n[1]),a=n.length>2?t(n[2]):"multipart/form-data",l=n.length>3?e(n[3]):null;return s.globals.form.dispatch(new en({success:i,error:o,submit_as:a,data:l})),{}},_signature:[]},request:{_func:(n,r,s)=>{const i=t(n[0]),o=t(n[1]),a=e(n[2]);let l,u,c={};return"string"==typeof n[3]?(s.globals.form.logger.warn("This usage of request is deprecated. Please see the documentation and update"),l=e(n[3]),u=e(n[4])):(c=e(n[3]),l=e(n[4]),u=e(n[5])),fr(s.globals,i,o,a,l,u,c),{}},_signature:[]},dispatchEvent:{_func:(t,n,r)=>{const s=t[0];let i,o=e(t[1]),a=t.length>2?e(t[2]):void 0,l=!1;return"string"==typeof s&&(a=o,o=s,l=!0),i=o.startsWith("custom:")?new nn(o.substring("custom:".length),a,l):((e,t={})=>{switch(e){case"change":return new Bt(t);case"submit":return new en(t);case"click":return new Ht(t);case"addItem":return new rn(t);case"removeItem":return new sn(t);default:console.error("invalid action")}})(o,a),null!=i&&("string"==typeof s?r.globals.form.dispatch(i):r.globals.form.getElement(s.$id).dispatch(i)),{}},_signature:[]}},this.customFunctions)}};class vr extends xn{constructor(e,t,n=new hr,r="off"){super(e,{}),this._fields={},this._invalidFields=[],this.dataRefRegex=/("[^"]+?"|[^.]+?)(?:\.|$)/g,this._ruleEngine=t,this._eventQueue=n,this._logger=new ur(r),this.queueEvent(new Qt),this.queueEvent(new zt),this._ids=function*(e=50){const t=function(){const t=[];for(let n=0;n<e;n++)t.push(Dn(10));return t},n={};let r=t();do{let e=r.pop();for(;e in n;)0===r.length&&(r=t()),e=r.pop();n[e]=!0,yield r.pop(),0===r.length&&(r=t())}while(r.length>0)}(),this._bindToDataModel(new un("$form",{})),this._initialize(),this.queueEvent(new Jt)}get logger(){return this._logger}get metaData(){return new Pn(this._jsonModel.metadata||{})}get action(){return this._jsonModel.action}_createChild(e){return ir(e,{form:this,parent:this})}importData(e){this._bindToDataModel(new un("$form",e)),this.syncDataAndFormModel(this.getDataNode()),this._eventQueue.runPendingQueue()}exportData(){var e;return null==(e=this.getDataNode())?void 0:e.$value}setFocus(e){const t=e.parent,n=e;for(;null!=t&&t.activeChild!=n;)t.activeChild=n}getState(){const e=this,t=super.getState();return t.id="$form",Object.defineProperty(t,"data",{get:function(){return e.exportData()}}),Object.defineProperty(t,"attachments",{get:function(){return An(e)}}),t}get type(){return"object"}isTransparent(){return!1}get form(){return this}get ruleEngine(){return this._ruleEngine}getUniqueId(){return null==this._ids?"":this._ids.next().value}fieldAdded(e){this._fields[e.id]=e,e.subscribe(e=>{-1===this._invalidFields.indexOf(e.target.id)&&this._invalidFields.push(e.target.id)},"invalid"),e.subscribe(e=>{const t=this._invalidFields.indexOf(e.target.id);t>-1&&this._invalidFields.splice(t,1)},"valid"),e.subscribe(e=>{const t=e.target.getState();if(t){const n=new tn(e.payload.changes,t);this.dispatch(n)}})}validate(){const e=super.validate();return this.dispatch(new Xt(e)),e}isValid(){return 0===this._invalidFields.length}dispatch(e){"submit"===e.type?(super.queueEvent(e),this._eventQueue.runPendingQueue()):super.dispatch(e)}executeAction(e){"submit"===e.type&&0!==this._invalidFields.length||super.executeAction(e)}submit(e,t){if(0===this.validate().length){const n=(null==e?void 0:e.payload)||{};(async(e,t,n,r="multipart/form-data",s=null)=>{const i=e.form.action;let o=s;"object"==typeof o&&null!=o||(o=e.form.exportData());const a=An(e.form);let l,u=r;Object.keys(a).length>0||"multipart/form-data"===r?(l=mr({data:o},a),u="multipart/form-data"):l={data:o},await fr(e,i,"POST",l,t,n,{"Content-Type":u})})(t,null==n?void 0:n.success,null==n?void 0:n.error,null==n?void 0:n.submit_as,null==n?void 0:n.data)}}getElement(e){return e==this.id?this:this._fields[e]}get qualifiedName(){return"$form"}getEventQueue(){return this._eventQueue}get name(){return"$form"}get value(){return null}get id(){return"$form"}get title(){return this._jsonModel.title||""}}class Er{constructor(){this._globalNames=["$form","$field","$event"]}compileRule(e){const t=yr.getFunctions();return new Tt(e,t,void 0,this._globalNames)}execute(e,t,n,r=!1){const s=this._context;let i;this._context=n;try{e.debug=[],i=e.search(t,n)}catch(e){var o,a,l;null==(o=this._context)||null==(a=o.form)||null==(l=a.logger)||l.error(e)}for(const t of e.debug){var u,c,h;null==(u=this._context)||null==(c=u.form)||null==(h=c.logger)||h.debug(t)}let d=i;return r&&"object"==typeof i&&null!==i&&(d=Object.getPrototypeOf(i).valueOf.call(i)),this._context=s,d}trackDependency(e){this._context&&void 0!==this._context.field&&this._context.field!==e&&e._addDependent(this._context.field)}}const Tr=(e,t,n="error",r)=>{try{let s=r;null==s&&(s=new vr(bt({},e),new Er,new hr(new ur(n)),n));const i=null==e?void 0:e.data;return i&&s.importData(i),"function"==typeof t&&t(s),s.getEventQueue().runPendingQueue(),s}catch(e){throw console.error(`Unable to create an instance of the Form ${e}`),new Error(e)}},br=(e,t)=>{try{const n=new vr(bt({},e),new Er);return t&&n.importData(t),0===n.validate().length}catch(e){throw new Error(e)}},Or=(e,t)=>{try{const n=new vr(bt({},e),new Er);t&&n.importData(t);const r=n.validate();return{messages:r,valid:0===r.length}}catch(e){throw new Error(e)}},Nr=(e,t={})=>{const n=new Headers;return Object.entries(t).forEach(([e,t])=>{n.append(e,t)}),dr(`${e}.model.json`,null,{headers:t}).then(e=>{if("model"in e){const{model:t}=e;e=t}return Ft(e)})},Mr="##",Rr="afs:translationIds",xr="properties",jr=["de-DE","en-US","es-ES","fr-FR","it-IT","ja-JP","ko-KR","pt-BR","zh-CN","zh-TW"],Pr=(e,t)=>{Ot.forEach(n=>{var r,s,i,o;n in t&&null!=e&&null!=(r=e.properties)&&null!=(s=r[Rr])&&s[n]&&(null==e||null==(i=e.properties)||null==(o=i[Rr])||delete o[n])})},wr=(e,t=[])=>{const n=e,r=[...Ot,...t];return $r(n,"",r),n},$r=(e,t,n)=>{Object.entries(e).forEach(([r,s])=>{if("object"==typeof s)e instanceof Array?s&&"name"in s&&$r(s,`${""===t?t:t+"##"}${s.name}`,n):$r(s,"items"===r?t:`${""===t?t:t+"##"}${r}`,n);else if(":type"in e||"type"in e||"fieldType"in e)for(const r of n)null!=Dr(e,r)&&("properties"in e||(e.properties={}),Rr in e.properties||(e.properties[Rr]={}),r in e.properties[Rr]||(e.properties[Rr][r]=`${t}##${r}##${Math.floor(1e4*Math.random())+1}`))})},Ir=(e,t,n)=>{Object.values(e).forEach(r=>{if("object"==typeof r)Ir(r,t,n);else for(const r of n){var s,i;const n=Dr(e,r);n&&null!=e&&null!=(s=e.properties)&&null!=(i=s[Rr])&&i[r]&&(n instanceof Array?n.forEach((n,s)=>{"string"==typeof n&&(t[`${e.properties[Rr][r]}##${s}`]=n)}):t[`${e.properties[Rr][r]}`]=n)}})},Dr=(e,t,n=null)=>{if(!t)return n;const r=Array.isArray(t)?t:t.split(".");let s=e,i=0;for(;i<r.length&&s.hasOwnProperty(r[i]);)s=s[r[i]],i++;return i==r.length?s:n},Ar=(e,t=[])=>{const n={},r=[...Ot,...t];return Ir(e,n,r),n},Sr=(e,t=[],n=[])=>{const r=[...Ot,...t],s=JSON.parse(JSON.stringify(e)),i=Ar(wr(s,t),r),o=[...jr,...n],a={};for(const e of o)a[e]=JSON.parse(JSON.stringify(i));return[s,a]};console.timeEnd("script af-core");export{Lt as ActionImpl,rn as AddItem,Nn as BaseNode,Wt as Blur,xr as CUSTOM_PROPS_KEY,Bt as Change,nr as Checkbox,rr as CheckboxGroup,Ht as Click,xn as Container,nn as CustomEvent,zt as ExecuteRule,Xn as Field,tn as FieldChanged,ar as Fieldset,wn as FileObject,tr as FileUpload,Zt as Focus,vr as Form,Jt as FormLoad,Pn as FormMetaData,yr as FunctionRuntime,Qt as Initialize,Gt as Invalid,jn as Node,sn as RemoveItem,Mn as Scriptable,en as Submit,Rr as TRANSLATION_ID,Mr as TRANSLATION_TOKEN,qt as Valid,Xt as ValidationComplete,Mt as ValidationError,wr as addTranslationId,St as checkIfConstraintsArePresent,Kt as checkIfKeyAdded,Nt as constraintProps,Tr as createFormInstance,Ar as createTranslationObj,Sr as createTranslationObject,Ut as deepClone,wt as defaultFieldTypes,It as exportDataSchema,kn as extractFileInfo,Nr as fetchForm,Sn as getFileSizeInBytes,Dr as getOrElse,Dt as getProperty,Pr as invalidateTranslation,Yt as isCheckbox,kt as isCheckboxGroup,Ct as isDateField,At as isFile,Ft as jsonString,Vt as propertyChange,fr as request,Ot as translationProps,Or as validateFormData,br as validateFormInstance};
//# sourceMappingURL=afcore-a3e20786.js.map
