console.time("script json-formula")
var t={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_CLASS:10,TYPE_ARRAY_ARRAY:11},e={TOK_EOF:"EOF",TOK_UNQUOTEDIDENTIFIER:"UnquotedIdentifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_FIELD:"Field",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_MULTIPLY:"Multiply",TOK_POWER:"Power",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_EQ:"EQ",TOK_GT:"GT",TOK_LT:"LT",TOK_GTE:"GTE",TOK_LTE:"LTE",TOK_NE:"NE",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_LITERAL:"Literal"};const{TYPE_NUMBER:r,TYPE_ANY:n,TYPE_STRING:s,TYPE_ARRAY:i,TYPE_OBJECT:u,TYPE_BOOLEAN:o,TYPE_EXPREF:c,TYPE_NULL:a,TYPE_ARRAY_NUMBER:l,TYPE_ARRAY_STRING:h,TYPE_CLASS:_,TYPE_ARRAY_ARRAY:p}=t,{TOK_EXPREF:T}=e,E={[r]:"number",[n]:"any",[s]:"string",[i]:"array",[u]:"object",[o]:"boolean",[c]:"expression",[a]:"null",[l]:"Array<number>",[h]:"Array<string>",[_]:"class",[p]:"Array<array>"};function f(t,e=!0){if(null===t)return a;let n=t;if(e){if("function"!=typeof t.valueOf)return u;n=t.valueOf.call(t)}switch(Object.prototype.toString.call(n)){case"[object String]":return s;case"[object Number]":return r;case"[object Array]":return i;case"[object Boolean]":return o;case"[object Null]":return a;case"[object Object]":return n.jmespathType===T?c:u;default:return u}}function d(t){return[f(t),f(t,!1)]}function y(t,e,c,T,f,g){const O=t[0];if(-1!==e.findIndex(t=>t===n||O===t))return c;let R=!1;if((O===u||1===e.length&&e[0]===_)&&(R=!0),O===i&&1===e.length&&e[0]===u&&(R=!0),e.includes(p)){if(O===i&&(c.forEach(t=>{t instanceof Array||(R=!0)}),!R))return c;R=!0}if(R)throw new Error(`TypeError: ${T} expected argument to be type ${E[e[0]]} but received type ${E[O]} instead.`);let N=-1;if(O===i&&e.includes(h)&&e.includes(l)&&(N=c.length>0&&"string"==typeof c[0]?h:l),-1===N&&[h,l,i].includes(O)&&(N=e.find(t=>[h,l,i].includes(t))),-1===N&&([N]=e),N===n)return c;if(N===h||N===l||N===i){if(N===i)return O===l||O===h?c:null===c?[]:[c];const e=N===l?r:s;if(O===i){const t=c.slice();for(let r=0;r<t.length;r+=1){const n=d(t[r]);t[r]=y(n,[e],t[r],T,f,g)}return t}if([r,s,a,o].includes(e))return[y(t,[e],c,T,f,g)]}else{if(N===r)return[s,o,a].includes(O)?f(c):0;if(N===s)return O===a||O===u?"":g(c);if(N===o)return!!c;if(N===u&&t[1]===u)return c}throw new Error("unhandled argument")}function g(t){return null!==t&&"[object Array]"===Object.prototype.toString.call(t)}function O(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)}function R(t){return null==t?t:g(t)?t.map(t=>R(t)):"function"!=typeof t.valueOf?t:t.valueOf()}function N(t,e){const r=R(t),n=R(e);if(r===n)return!0;if(Object.prototype.toString.call(r)!==Object.prototype.toString.call(n))return!1;if(!0===g(r)){if(r.length!==n.length)return!1;for(let t=0;t<r.length;t+=1)if(!1===N(r[t],n[t]))return!1;return!0}if(!0===O(r)){const t={};for(const e in r)if(hasOwnProperty.call(r,e)){if(!1===N(r[e],n[e]))return!1;t[e]=!0}for(const e in n)if(hasOwnProperty.call(n,e)&&!0!==t[e])return!1;return!0}return!1}const{TOK_CURRENT:P,TOK_GLOBAL:m,TOK_EXPREF:Y,TOK_PIPE:v,TOK_EQ:A,TOK_GT:K,TOK_LT:I,TOK_GTE:S,TOK_LTE:b,TOK_NE:x,TOK_FLATTEN:U}=e,{TYPE_STRING:M,TYPE_ARRAY_STRING:w,TYPE_ARRAY:L}=t;function B(t){if(null===t)return!0;const e=R(t);if(""===e||!1===e||null===e)return!0;if(g(e)&&0===e.length)return!0;if(O(e)){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}return!e}class k{constructor(t,e,r,n,s,i){this.runtime=t,this.globals=e,this.toNumber=r,this.toString=n,this.debug=s,this.language=i}search(t,e){return this.visit(t,e)}visit(t,e){const r=t&&{Field:(t,e)=>{if(null!==e&&(O(e)||g(e))){let r=e[t.name];if("function"==typeof r&&(r=void 0),void 0===r){try{this.debug.push(`Failed to find: '${t.name}'`);const r=Object.keys(e).map(t=>`'${t}'`).toString();r.length&&this.debug.push(`Available fields: ${r}`)}catch(t){}return null}return r}return null},Subexpression:(t,e)=>{let r=this.visit(t.children[0],e);for(let e=1;e<t.children.length;e+=1)if(r=this.visit(t.children[1],r),null===r)return null;return r},IndexExpression:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},Index:(t,e)=>{if(g(e)){let r=this.toNumber(this.visit(t.value,e));r<0&&(r=e.length+r);const n=e[r];return void 0===n?(this.debug.push(`Index ${r} out of range`),null):n}if(O(e)){const r=this.toString(this.visit(t.value,e)),n=e[r];return void 0===n?(this.debug.push(`Key ${r} does not exist`),null):n}return this.debug.push(`left side of index expression ${e} is not an array or object.`),null},Slice:(t,e)=>{if(!g(e))return null;const r=t.children.slice(0).map(t=>null!=t?this.toNumber(this.visit(t,e)):null),n=this.computeSliceParams(e.length,r),[s,i,u]=n,o=[];if(u>0)for(let t=s;t<i;t+=u)o.push(e[t]);else for(let t=s;t>i;t+=u)o.push(e[t]);return o},Projection:(t,e)=>{const r=this.visit(t.children[0],e);if(!g(r))return null;const n=[];return r.forEach(e=>{const r=this.visit(t.children[1],e);null!==r&&n.push(r)}),n},ValueProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!O(R(r)))return null;const n=[];return Object.values(r).forEach(e=>{const r=this.visit(t.children[1],e);null!==r&&n.push(r)}),n},FilterProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!g(r))return null;const n=r.filter(e=>!B(this.visit(t.children[2],e))),s=[];return n.forEach(e=>{const r=this.visit(t.children[1],e);null!==r&&s.push(r)}),s},Comparator:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);if(t.name===A)return N(r,n);if(t.name===x)return!N(r,n);if(t.name===K)return r>n;if(t.name===S)return r>=n;if(t.name===I)return r<n;if(t.name===b)return r<=n;throw new Error(`Unknown comparator: ${t.name}`)},[U]:(t,e)=>{const r=this.visit(t.children[0],e);if(!g(r))return null;const n=[];return r.forEach(t=>{g(t)?n.push(...t):n.push(t)}),n},Identity:(t,e)=>e,MultiSelectList:(t,e)=>null===e?null:t.children.map(t=>this.visit(t,e)),MultiSelectHash:(t,e)=>{if(null===e)return null;const r={};return t.children.forEach(t=>{r[t.name]=this.visit(t.value,e)}),r},OrExpression:(t,e)=>{let r=this.visit(t.children[0],e);return B(r)&&(r=this.visit(t.children[1],e)),r},AndExpression:(t,e)=>{const r=this.visit(t.children[0],e);return!0===B(r)?r:this.visit(t.children[1],e)},AddExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"+")},ConcatenateExpression:(t,e)=>{let r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return r=y(d(r),[M,w],r,"concatenate",this.toNumber,this.toString),n=y(d(n),[M,w],n,"concatenate",this.toNumber,this.toString),this.applyOperator(r,n,"&")},UnionExpression:(t,e)=>{let r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return r=y(d(r),[L],r,"union",this.toNumber,this.toString),n=y(d(n),[L],n,"union",this.toNumber,this.toString),r.concat(n)},SubtractExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"-")},MultiplyExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"*")},DivideExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"/")},PowerExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"^")},NotExpression:(t,e)=>B(this.visit(t.children[0],e)),Literal:t=>t.value,Number:t=>t.value,[v]:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},[P]:(t,e)=>e,[m]:t=>{const e=this.globals[t.name];return void 0===e?null:e},Function:(t,e)=>{if("if"===t.name)return this.runtime.callFunction(t.name,t.children,e,this,!1);const r=t.children.map(t=>this.visit(t,e));return this.runtime.callFunction(t.name,r,e,this)},ExpressionReference:t=>{const[e]=t.children;return e.jmespathType=Y,e}}[t.type];if(!r)throw new Error(`Unknown/missing node type ${t&&t.type||""}`);return r(t,e)}computeSliceParams(t,e){function r(t,e,r){let n=e;return n<0?(n+=t,n<0&&(n=r<0?-1:0)):n>=t&&(n=r<0?t-1:t),n}let[n,s,i]=e;if(null===i)i=1;else if(0===i){const t=new Error("Invalid slice, step cannot be 0");throw t.name="RuntimeError",t}const u=i<0;return n=null===n?u?t-1:0:r(t,n,i),s=null===s?u?-1:t:r(t,s,i),[n,s,i]}applyOperator(t,e,r){if(g(t)&&g(e)){const n=t.length<e.length?t:e,s=Math.abs(t.length-e.length);n.length+=s,n.fill(null,n.length-s);const i=[];for(let n=0;n<t.length;n+=1)i.push(this.applyOperator(t[n],e[n],r));return i}if(g(t))return t.map(t=>this.applyOperator(t,e,r));if(g(e))return e.map(e=>this.applyOperator(t,e,r));if("*"===r)return this.toNumber(t)*this.toNumber(e);if("&"===r)return t+e;if("+"===r)return this.toNumber(t)+this.toNumber(e);if("-"===r)return this.toNumber(t)-this.toNumber(e);if("/"===r){const r=t/e;return Number.isFinite(r)?r:null}if("^"===r)return t**e;throw new Error(`Unknown operator: ${r}`)}}const{TOK_UNQUOTEDIDENTIFIER:C,TOK_QUOTEDIDENTIFIER:j,TOK_RBRACKET:D,TOK_RPAREN:G,TOK_COMMA:F,TOK_COLON:$,TOK_CONCATENATE:H,TOK_RBRACE:Q,TOK_NUMBER:J,TOK_CURRENT:q,TOK_GLOBAL:z,TOK_EXPREF:X,TOK_PIPE:V,TOK_OR:W,TOK_AND:Z,TOK_ADD:tt,TOK_SUBTRACT:et,TOK_MULTIPLY:rt,TOK_POWER:nt,TOK_DIVIDE:st,TOK_UNION:it,TOK_EQ:ut,TOK_GT:ot,TOK_LT:ct,TOK_GTE:at,TOK_LTE:lt,TOK_NE:ht,TOK_FLATTEN:_t,TOK_STAR:pt,TOK_FILTER:Tt,TOK_DOT:Et,TOK_NOT:ft,TOK_LBRACE:dt,TOK_LBRACKET:yt,TOK_LPAREN:gt,TOK_LITERAL:Ot}=e,Rt={".":Et,",":F,":":$,"{":dt,"}":Q,"]":D,"(":gt,")":G,"@":q},Nt={"<":!0,">":!0,"=":!0,"!":!0},Pt={" ":!0,"\t":!0,"\n":!0};function mt(t,e){return t>="0"&&t<="9"||e&&"-"===t||"."===t}function Yt(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||"_"===t}function vt(t,e){const r=t[e];return"$"===r?t.length>e&&Yt(t[e+1]):r>="a"&&r<="z"||r>="A"&&r<="Z"||"_"===r}class At{constructor(t=[],e=[]){this._allowedGlobalNames=t,this.debug=e}tokenize(t){const e=[];let r,n,s;for(this._current=0;this._current<t.length;){const i=e.length?e.slice(-1)[0].type:null;if(this._isGlobal(i,t,this._current))e.push(this._consumeGlobal(t));else if(vt(t,this._current))r=this._current,n=this._consumeUnquotedIdentifier(t),e.push({type:C,value:n,start:r});else if(void 0!==Rt[t[this._current]])e.push({type:Rt[t[this._current]],value:t[this._current],start:this._current}),this._current+=1;else if("-"===t[this._current]&&![q,J,G,C,j,D].includes(i)||mt(t[this._current],!1))s=this._consumeNumber(t),e.push(s);else if("["===t[this._current])s=this._consumeLBracket(t),e.push(s);else if('"'===t[this._current])r=this._current,n=this._consumeQuotedIdentifier(t),e.push({type:j,value:n,start:r});else if("'"===t[this._current])r=this._current,n=this._consumeRawStringLiteral(t),e.push({type:Ot,value:n,start:r});else if("`"===t[this._current]){r=this._current;const n=this._consumeLiteral(t);e.push({type:Ot,value:n,start:r})}else if(void 0!==Nt[t[this._current]])e.push(this._consumeOperator(t));else if(void 0!==Pt[t[this._current]])this._current+=1;else if("&"===t[this._current])r=this._current,this._current+=1,"&"===t[this._current]?(this._current+=1,e.push({type:Z,value:"&&",start:r})):e.push(i===F||i===gt?{type:X,value:"&",start:r}:{type:H,value:"&",start:r});else if("~"===t[this._current])r=this._current,this._current+=1,e.push({type:it,value:"~",start:r});else if("+"===t[this._current])r=this._current,this._current+=1,e.push({type:tt,value:"+",start:r});else if("-"===t[this._current])r=this._current,this._current+=1,e.push({type:et,value:"-",start:r});else if("*"===t[this._current]){r=this._current,this._current+=1;const t=e.length&&e.slice(-1)[0].type;0===e.length||[yt,Et,V,Z,W,F,$].includes(t)?e.push({type:pt,value:"*",start:r}):e.push({type:rt,value:"*",start:r})}else if("/"===t[this._current])r=this._current,this._current+=1,e.push({type:st,value:"/",start:r});else if("^"===t[this._current])r=this._current,this._current+=1,e.push({type:nt,value:"^",start:r});else{if("|"!==t[this._current]){const e=new Error(`Unknown character:${t[this._current]}`);throw e.name="LexerError",e}r=this._current,this._current+=1,"|"===t[this._current]?(this._current+=1,e.push({type:W,value:"||",start:r})):e.push({type:V,value:"|",start:r})}}return e}_consumeUnquotedIdentifier(t){const e=this._current;for(this._current+=1;this._current<t.length&&Yt(t[this._current]);)this._current+=1;return t.slice(e,this._current)}_consumeQuotedIdentifier(t){const e=this._current;this._current+=1;const r=t.length;let n=!vt(t,e+1);for(;'"'!==t[this._current]&&this._current<r;){let e=this._current;Yt(t[e])||(n=!0),e+="\\"!==t[e]||"\\"!==t[e+1]&&'"'!==t[e+1]?1:2,this._current=e}this._current+=1;const s=t.slice(e,this._current);try{n&&!s.includes(" ")||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? '${s.replace(/"/g,"")}'?`))}catch(t){}return JSON.parse(s)}_consumeRawStringLiteral(t){const e=this._current;this._current+=1;const r=t.length;for(;"'"!==t[this._current]&&this._current<r;){let e=this._current;e+="\\"!==t[e]||"\\"!==t[e+1]&&"'"!==t[e+1]?1:2,this._current=e}return this._current+=1,t.slice(e+1,this._current-1).replaceAll("\\'","'")}_consumeNumber(t){const e=this._current;this._current+=1;const r=t.length;for(;mt(t[this._current],!1)&&this._current<r;)this._current+=1;const n=t.slice(e,this._current);let s;return s=n.includes(".")?parseFloat(n):parseInt(n,10),{type:J,value:s,start:e}}_consumeLBracket(t){const e=this._current;return this._current+=1,"?"===t[this._current]?(this._current+=1,{type:Tt,value:"[?",start:e}):"]"===t[this._current]?(this._current+=1,{type:_t,value:"[]",start:e}):{type:yt,value:"[",start:e}}_isGlobal(t,e,r){if(null!==t&&t===Et)return!1;if("$"!==e[r])return!1;let n=r+1;for(;n<e.length&&Yt(e[n]);)n+=1;const s=e.slice(r,n);return this._allowedGlobalNames.includes(s)}_consumeGlobal(t){const e=this._current;for(this._current+=1;this._current<t.length&&Yt(t[this._current]);)this._current+=1;const r=t.slice(e,this._current);return{type:z,name:r,start:e}}_consumeOperator(t){const e=this._current,r=t[e];return this._current+=1,"!"===r?"="===t[this._current]?(this._current+=1,{type:ht,value:"!=",start:e}):{type:ft,value:"!",start:e}:"<"===r?"="===t[this._current]?(this._current+=1,{type:lt,value:"<=",start:e}):{type:ct,value:"<",start:e}:">"===r?"="===t[this._current]?(this._current+=1,{type:at,value:">=",start:e}):{type:ot,value:">",start:e}:"="===t[this._current]?(this._current+=1,{type:ut,value:"==",start:e}):{type:ut,value:"=",start:e}}_consumeLiteral(t){this._current+=1;const e=this._current,r=t.length;let n,s=!1;for(;(s||"`"!==t[this._current])&&this._current<r;){let e=this._current;s&&"\\"===t[e]&&'"'===t[e+1]?e+=2:('"'===t[e]&&(s=!s),e+=s&&"`"===t[e+1]?2:"\\"!==t[e]||"\\"!==t[e+1]&&"`"!==t[e+1]?1:2),this._current=e}let i=t.slice(e,this._current).trimStart();return i=i.replaceAll("\\`","`"),n=function(t){if(""===t)return!1;if('[{"'.includes(t[0]))return!0;if(["true","false","null"].includes(t))return!0;if(!"-0123456789".includes(t[0]))return!1;try{return JSON.parse(t),!0}catch(t){return!1}}(i)?JSON.parse(i):JSON.parse(`"${i}"`),this._current+=1,n}}const{TOK_LITERAL:Kt,TOK_COLON:It,TOK_EOF:St,TOK_UNQUOTEDIDENTIFIER:bt,TOK_QUOTEDIDENTIFIER:xt,TOK_RBRACKET:Ut,TOK_RPAREN:Mt,TOK_COMMA:wt,TOK_CONCATENATE:Lt,TOK_RBRACE:Bt,TOK_NUMBER:kt,TOK_CURRENT:Ct,TOK_GLOBAL:jt,TOK_FIELD:Dt,TOK_EXPREF:Gt,TOK_PIPE:Ft,TOK_OR:$t,TOK_AND:Ht,TOK_ADD:Qt,TOK_SUBTRACT:Jt,TOK_MULTIPLY:qt,TOK_POWER:zt,TOK_DIVIDE:Xt,TOK_UNION:Vt,TOK_EQ:Wt,TOK_GT:Zt,TOK_LT:te,TOK_GTE:ee,TOK_LTE:re,TOK_NE:ne,TOK_FLATTEN:se,TOK_STAR:ie,TOK_FILTER:ue,TOK_DOT:oe,TOK_NOT:ce,TOK_LBRACE:ae,TOK_LBRACKET:le,TOK_LPAREN:he}=e,_e={[St]:0,[bt]:0,[xt]:0,[Ut]:0,[Mt]:0,[wt]:0,[Bt]:0,[kt]:0,[Ct]:0,[jt]:0,[Dt]:0,[Gt]:0,[Ft]:1,[$t]:2,[Ht]:3,[Qt]:6,[Jt]:6,[Lt]:7,[qt]:7,[Xt]:7,[zt]:7,[Vt]:7,[Wt]:5,[Zt]:5,[te]:5,[ee]:5,[re]:5,[ne]:5,[se]:9,[ie]:20,[ue]:21,[oe]:40,[ce]:45,[ae]:50,[le]:55,[he]:60};class pe{constructor(t=[]){this._allowedGlobalNames=t}parse(t,e){this._loadTokens(t,e),this.index=0;const r=this.expression(0);if(this._lookahead(0)!==St){const t=this._lookaheadToken(0),e=new Error(`Unexpected token type: ${t.type}, value: ${t.value}`);throw e.name="ParserError",e}return r}_loadTokens(t,e){const r=new At(this._allowedGlobalNames,e).tokenize(t);r.push({type:St,value:"",start:t.length}),this.tokens=r}expression(t){const e=this._lookaheadToken(0);this._advance();let r=this.nud(e),n=this._lookahead(0);for(;t<_e[n];)this._advance(),r=this.led(n,r),n=this._lookahead(0);return r}_lookahead(t){return this.tokens[this.index+t].type}_lookaheadToken(t){return this.tokens[this.index+t]}_advance(){this.index+=1}_getIndex(){return this.index}_setIndex(t){this.index=t}nud(t){let e,r,n,s,i;switch(t.type){case Kt:return{type:"Literal",value:t.value};case kt:return{type:"Number",value:t.value};case bt:return{type:"Field",name:t.value};case xt:if(s={type:"Field",name:t.value},this._lookahead(0)===he)throw new Error("Quoted identifier not allowed for function names.");return s;case ce:return r=this.expression(_e.Not),{type:"NotExpression",children:[r]};case ie:return e={type:"Identity"},r=this._lookahead(0)===Ut?{type:"Identity"}:this._parseProjectionRHS(_e.Star),{type:"ValueProjection",children:[e,r]};case ue:return this.led(t.type,{type:"Identity"});case ae:return this._parseMultiselectHash();case se:return e={type:se,children:[{type:"Identity"}]},r=this._parseProjectionRHS(_e.Flatten),{type:"Projection",children:[e,r]};case le:return this._lookahead(0)===ie&&this._lookahead(1)===Ut?(this._advance(),this._advance(),r=this._parseProjectionRHS(_e.Star),{type:"Projection",children:[{type:"Identity"},r]}):this._parseUnchainedIndexExpression();case Ct:return{type:Ct};case jt:return{type:jt,name:t.name};case Dt:return{type:Dt};case Gt:return n=this.expression(_e.Expref),{type:"ExpressionReference",children:[n]};case he:for(i=[];this._lookahead(0)!==Mt;)n=this.expression(0),i.push(n);return this._match(Mt),i[0];default:this._errorToken(t)}}led(t,e){let r,n,s,i,u,o,c,a,l;switch(t){case Lt:return n=this.expression(_e.Concatenate),{type:"ConcatenateExpression",children:[e,n]};case oe:return c=_e.Dot,this._lookahead(0)!==ie?(n=this._parseDotRHS(c),{type:"Subexpression",children:[e,n]}):(this._advance(),n=this._parseProjectionRHS(c),{type:"ValueProjection",children:[e,n]});case Ft:return n=this.expression(_e.Pipe),{type:Ft,children:[e,n]};case $t:return n=this.expression(_e.Or),{type:"OrExpression",children:[e,n]};case Ht:return n=this.expression(_e.And),{type:"AndExpression",children:[e,n]};case Qt:return n=this.expression(_e.Add),{type:"AddExpression",children:[e,n]};case Jt:return n=this.expression(_e.Subtract),{type:"SubtractExpression",children:[e,n]};case qt:return n=this.expression(_e.Multiply),{type:"MultiplyExpression",children:[e,n]};case Xt:return n=this.expression(_e.Divide),{type:"DivideExpression",children:[e,n]};case zt:return n=this.expression(_e.Power),{type:"PowerExpression",children:[e,n]};case Vt:return n=this.expression(_e.Power),{type:"UnionExpression",children:[e,n]};case he:for(s=e.name,i=[];this._lookahead(0)!==Mt;)u=this.expression(0),this._lookahead(0)===wt&&this._match(wt),i.push(u);return this._match(Mt),o={type:"Function",name:s,children:i},o;case ue:return r=this.expression(0),this._match(Ut),n=this._lookahead(0)===se?{type:"Identity"}:this._parseProjectionRHS(_e.Filter),{type:"FilterProjection",children:[e,n,r]};case se:return a={type:se,children:[e]},l=this._parseProjectionRHS(_e.Flatten),{type:"Projection",children:[a,l]};case Wt:case ne:case Zt:case ee:case te:case re:return this._parseComparator(e,t);case le:return this._lookahead(0)===ie&&this._lookahead(1)===Ut?(this._advance(),this._advance(),n=this._parseProjectionRHS(_e.Star),{type:"Projection",children:[e,n]}):(n=this._parseChainedIndexExpression(),this._projectIfSlice(e,n));default:this._errorToken(this._lookaheadToken(0))}}_match(t){if(this._lookahead(0)!==t){const e=this._lookaheadToken(0),r=new Error(`Expected ${t}, got: ${e.type}`);throw r.name="ParserError",r}this._advance()}_errorToken(t){const e=new Error(`Invalid token (${t.type}): "${t.value}"`);throw e.name="ParserError",e}_parseChainedIndexExpression(){const t=this._getIndex();if(this._lookahead(0)===It)return this._parseSliceExpression();const e=this.expression(0);return this._lookahead(0)===It?(this._setIndex(t),this._parseSliceExpression()):(this._match(Ut),{type:"Index",value:e})}_parseUnchainedIndexExpression(){const t=this._getIndex(),e=this._lookahead(0);if(e===It){const t=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},t)}const r=this.expression(0),n=this._lookahead(0);if(n===wt)return this._setIndex(t),this._parseMultiselectList();if(n===It){this._setIndex(t);const e=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},e)}return e===kt?(this._match(Ut),{type:"Index",value:r}):(this._setIndex(t),this._parseMultiselectList())}_projectIfSlice(t,e){const r={type:"IndexExpression",children:[t,e]};return"Slice"===e.type?{type:"Projection",children:[r,this._parseProjectionRHS(_e.Star)]}:r}_parseSliceExpression(){const t=[null,null,null];let e=0,r=this._lookahead(0);for(;r!==Ut&&e<3;){if(r===It&&e<2)e+=1,this._advance();else{t[e]=this.expression(0);const r=this._lookahead(0);if(r!==It&&r!==Ut){const t=new Error(`Syntax error, unexpected token: ${r.value}(${r.type})`);throw t.name="Parsererror",t}}r=this._lookahead(0)}return this._match(Ut),{type:"Slice",children:t}}_parseComparator(t,e){return{type:"Comparator",name:e,children:[t,this.expression(_e[e])]}}_parseDotRHS(t){const e=this._lookahead(0);return[bt,xt,ie].indexOf(e)>=0?this.expression(t):e===le?(this._match(le),this._parseMultiselectList()):e===ae?(this._match(ae),this._parseMultiselectHash()):void 0}_parseProjectionRHS(t){let e;if(_e[this._lookahead(0)]<10)e={type:"Identity"};else if(this._lookahead(0)===le)e=this.expression(t);else if(this._lookahead(0)===ue)e=this.expression(t);else{if(this._lookahead(0)!==oe){const t=this._lookaheadToken(0),e=new Error(`Sytanx error, unexpected token: ${t.value}(${t.type})`);throw e.name="ParserError",e}this._match(oe),e=this._parseDotRHS(t)}return e}_parseMultiselectList(){const t=[];for(;this._lookahead(0)!==Ut;){const e=this.expression(0);if(t.push(e),this._lookahead(0)===wt&&(this._match(wt),this._lookahead(0)===Ut))throw new Error("Unexpected token Rbracket")}return this._match(Ut),{type:"MultiSelectList",children:t}}_parseMultiselectHash(){const t=[],e=[bt,xt];let r,n,s,i;if(this._lookahead(0)===Bt)return this._advance(),{type:"MultiSelectHash",children:[]};for(;;){if(r=this._lookaheadToken(0),e.indexOf(r.type)<0)throw new Error(`Expecting an identifier token, got: ${r.type}`);if(n=r.value,this._advance(),this._match(It),s=this.expression(0),i={type:"KeyValuePair",name:n,value:s},t.push(i),this._lookahead(0)===wt)this._match(wt);else if(this._lookahead(0)===Bt){this._match(Bt);break}}return{type:"MultiSelectHash",children:t}}}function Te(t,e){const r=10**e;return Math.round(t*r)/r}function Ee(e,r,n,s=[]){return{casefold:{_func:(t,e,n)=>r(t[0]).toLocaleUpperCase(n.language).toLocaleLowerCase(n.language),_signature:[{types:[t.TYPE_STRING]}]},and:{_func:t=>{let r=!!e(t[0]);return t.slice(1).forEach(t=>{r=r&&!!e(t)}),r},_signature:[{types:[t.TYPE_ANY],variadic:!0}]},deepScan:{_func:t=>{const[e,r]=t,n=r.toString(),s=[];return null===e||function t(e){Object.entries(e).forEach(([e,r])=>{e===n&&s.push(r),"object"==typeof r&&t(r)})}(e),s},_signature:[{types:[t.TYPE_OBJECT,t.TYPE_ARRAY,t.TYPE_NULL]},{types:[t.TYPE_STRING,t.TYPE_NUMBER]}]},or:{_func:t=>{let r=!!e(t[0]);return t.slice(1).forEach(t=>{r=r||!!e(t)}),r},_signature:[{types:[t.TYPE_ANY],variadic:!0}]},not:{_func:t=>!e(t[0]),_signature:[{types:[t.TYPE_ANY]}]},null:{_func:()=>null,_signature:[]},true:{_func:()=>!0,_signature:[]},false:{_func:()=>!1,_signature:[]},if:{_func:(t,r,n)=>{const s=t[1],i=t[2],u=n.visit(t[0],r);return e(u)?n.visit(s,r):n.visit(i,r)},_signature:[{types:[t.TYPE_ANY]},{types:[t.TYPE_ANY]},{types:[t.TYPE_ANY]}]},substitute:{_func:t=>{const e=r(t[0]),s=r(t[1]),i=r(t[2]);if(t.length<=3)return e.replaceAll(s,i);const u=n(t[3]);if(u<1)return e;let o=-1;for(let t=0;t<u;t+=1){o+=1;const t=e.slice(o).indexOf(s);if(-1===t)return e;o+=t}return e.slice(0,o)+e.slice(o).replace(s,i)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER],optional:!0}]},value:{_func:t=>{const e=t[0]||{},r=t[1],n=e[r];if(void 0===n){s.push(`Failed to find: '${r}'`);const t=Object.keys(e).map(t=>`'${t}'`).toString();return t.length&&s.push(`Available fields: ${t}`),null}return n},_signature:[{types:[t.TYPE_OBJECT,t.TYPE_ARRAY,t.TYPE_NULL]},{types:[t.TYPE_STRING,t.TYPE_NUMBER]}]},lower:{_func:t=>r(t[0]).toLowerCase(),_signature:[{types:[t.TYPE_STRING]}]},upper:{_func:t=>r(t[0]).toUpperCase(),_signature:[{types:[t.TYPE_STRING]}]},exp:{_func:t=>{const e=n(t[0]);return Math.exp(e)},_signature:[{types:[t.TYPE_NUMBER]}]},power:{_func:t=>n(t[0])**n(t[1]),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},find:{_func:t=>{const e=r(t[0]),s=r(t[1]),i=t.length>2?n(t[2]):0,u=s.indexOf(e,i);return-1===u?null:u},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER],optional:!0}]},left:{_func:t=>{const e=t.length>1?n(t[1]):1;return e<0?null:t[0]instanceof Array?t[0].slice(0,e):r(t[0]).substr(0,e)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER],optional:!0}]},right:{_func:t=>{const e=t.length>1?n(t[1]):1;if(e<0)return null;if(t[0]instanceof Array)return 0===e?[]:t[0].slice(-1*e);const s=r(t[0]);return s.substr(s.length-e,e)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER],optional:!0}]},mid:{_func:t=>{const e=n(t[1]),s=n(t[2]);return e<0?null:t[0]instanceof Array?t[0].slice(e,e+s):r(t[0]).substr(e,s)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},mod:{_func:t=>n(t[0])%n(t[1]),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},proper:{_func:t=>r(t[0]).split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "),_signature:[{types:[t.TYPE_STRING]}]},rept:{_func:t=>{const e=r(t[0]),s=n(t[1]);return s<0?null:e.repeat(s)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER]}]},replace:{_func:t=>{const e=r(t[0]),s=n(t[1]),i=n(t[2]),u=r(t[3]);return s<0?null:e.substr(0,s)+u+e.substr(s+i)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_STRING]}]},round:{_func:t=>Te(n(t[0]),n(t[1])),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},sqrt:{_func:t=>{const e=Math.sqrt(n(t[0]));return Number.isNaN(e)?null:e},_signature:[{types:[t.TYPE_NUMBER]}]},stdevp:{_func:t=>{const e=t[0]||[];if(0===e.length)return null;const r=e.map(t=>n(t)),s=r.reduce((t,e)=>t+e,0)/e.length,i=r.reduce((t,e)=>t+e*e,0)/e.length,u=Math.sqrt(i-s*s);return Number.isNaN(u)?null:u},_signature:[{types:[t.TYPE_ARRAY_NUMBER]}]},stdev:{_func:t=>{const e=t[0]||[];if(e.length<=1)return null;const r=e.map(t=>n(t)),s=r.reduce((t,e)=>t+e,0)/e.length,i=r.reduce((t,e)=>t+e*e,0),u=Math.sqrt((i-e.length*s*s)/(e.length-1));return Number.isNaN(u)?null:u},_signature:[{types:[t.TYPE_ARRAY_NUMBER]}]},trim:{_func:t=>r(t[0]).split(" ").filter(t=>t).join(" "),_signature:[{types:[t.TYPE_STRING]}]},trunc:{_func:t=>{const e=n(t[0]),r=t.length>1?n(t[1]):0;return(e>=0?Math.floor:Math.ceil)(e*10**r)/10**r},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0}]},charCode:{_func:t=>{const e=n(t[0]);return Number.isInteger(e)?String.fromCharCode(e):null},_signature:[{types:[t.TYPE_NUMBER]}]},codePoint:{_func:t=>{const e=r(t[0]);return 0===e.length?null:e.codePointAt(0)},_signature:[{types:[t.TYPE_STRING]}]},datetime:{_func:t=>{const e=n(t[0]),s=n(t[1]),i=n(t[2]),u=t.length>3?n(t[3]):0,o=t.length>4?n(t[4]):0,c=t.length>5?n(t[5]):0,a=t.length>6?n(t[6]):0,l=t.length>7?r(t[7]):null;let h=new Date(e,s-1,i,u,o,c,a);return l&&(h=function(t,e){if(null===t)return null;let r=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds());return r+=function(t,e){const r=new Intl.DateTimeFormat("en-US",{timeZone:e,timeZoneName:"longOffset"}).format(t),n=/GMT([+\-−])?(\d{1,2}):?(\d{0,2})?/.exec(r);if(!n)return 0;const[s,i,u]=n.slice(1),o=60*(60*(i||0)+1*(u||0))*1e3;return"-"===s?-1*o:o}(t,e),new Date(r)}(h,l)),h.getTime()/864e5},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_STRING],optional:!0}]},datedif:{_func:t=>{const e=n(t[0]),s=n(t[1]),i=r(t[2]).toLowerCase();if(s===e)return 0;if(s<e)return null;if("d"===i)return Math.floor(s-e);const u=new Date(864e5*e),o=new Date(864e5*s),c=o.getFullYear()-u.getFullYear();let a=o.getMonth()-u.getMonth();const l=o.getDate()-u.getDate();if("y"===i){let t=c;return a<0&&(t-=1),0===a&&l<0&&(t-=1),t}if("m"===i)return 12*c+a+(l<0?-1:0);if("ym"===i)return l<0&&(a-=1),a<=0&&c>0?12+a:a;if("yd"===i)return l<0&&(a-=1),o.setFullYear(a<0?u.getFullYear()+1:u.getFullYear()),Math.floor((o.getTime()-u.getTime())/864e5);throw new TypeError(`Unrecognized unit parameter "${i}" for datedif()`)},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_STRING]}]},eomonth:{_func:t=>{const e=n(t[0]),r=n(t[1]),s=new Date(864e5*e);return new Date(s.getFullYear(),s.getMonth()+r+1,0).getTime()/864e5},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},day:{_func:t=>{const e=n(t[0]);return new Date(864e5*e).getDate()},_signature:[{types:[t.TYPE_NUMBER]}]},month:{_func:t=>{const e=n(t[0]);return new Date(864e5*e).getMonth()+1},_signature:[{types:[t.TYPE_NUMBER]}]},year:{_func:t=>{const e=n(t[0]);return new Date(864e5*e).getFullYear()},_signature:[{types:[t.TYPE_NUMBER]}]},time:{_func:t=>{const e=(3600*n(t[0])+60*n(t[1])+n(t[2]))/86400;return e<0?null:e-Math.floor(e)},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},hour:{_func:t=>{const e=n(t[0])%1;if(e<0)return null;const r=Te(24*e,14);return Math.floor(r%24)},_signature:[{types:[t.TYPE_NUMBER]}]},minute:{_func:t=>{const e=n(t[0])%1;if(e<0)return null;const r=Math.round(1440*e,10);return Math.floor(r%60)},_signature:[{types:[t.TYPE_NUMBER]}]},second:{_func:t=>{const e=n(t[0])%1;if(e<0)return null;const r=Te(86400*e,10);return Math.floor(r%60)},_signature:[{types:[t.TYPE_NUMBER]}]},now:{_func:()=>Date.now()/864e5,_signature:[]},today:{_func:()=>Math.floor(Date.now()/864e5),_signature:[]},weekday:{_func:t=>{const e=n(t[0]),r=t.length>1?n(t[1]):1,s=new Date(864e5*e).getDay();switch(r){case 1:return s+1;case 2:return(s+6)%7+1;case 3:return(s+6)%7;default:return null}},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0}]},entries:{_func:t=>{const r=e(t[0]);return Object.entries(r)},_signature:[{types:[t.TYPE_NUMBER,t.TYPE_STRING,t.TYPE_ARRAY,t.TYPE_OBJECT,t.TYPE_BOOLEAN]}]},fromEntries:{_func:t=>Object.fromEntries(t[0]),_signature:[{types:[t.TYPE_ARRAY_ARRAY]}]},split:{_func:t=>{const e=r(t[0]),n=r(t[1]);return e.split(n)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]}]},unique:{_func:t=>{const r=t[0].map(t=>e(t));return t[0].filter((t,n)=>r.indexOf(e(t))===n)},_signature:[{types:[t.TYPE_ARRAY]}]},encodeUrlComponent:{_func:t=>encodeURIComponent(t[0]),_signature:[{types:[t.TYPE_STRING]}]},encodeUrl:{_func:t=>encodeURI(t[0]),_signature:[{types:[t.TYPE_STRING]}]},decodeUrlComponent:{_func:t=>decodeURIComponent(t[0]),_signature:[{types:[t.TYPE_STRING]}]},decodeUrl:{_func:t=>decodeURI(t[0]),_signature:[{types:[t.TYPE_STRING]}]}}}function fe(e,r,n,s,i,u,o){const{TYPE_NUMBER:c,TYPE_ANY:a,TYPE_STRING:l,TYPE_ARRAY:h,TYPE_OBJECT:_,TYPE_BOOLEAN:p,TYPE_EXPREF:T,TYPE_NULL:E,TYPE_ARRAY_NUMBER:f,TYPE_ARRAY_STRING:d}=t;function y(t,r){return n=>{const s=e.visit(t,n);if(r.indexOf(i(s))<0){const t=`TypeError: expected one of ${r}, received ${i(s)}`;throw new Error(t)}return s}}return{abs:{_func:t=>Math.abs(t[0]),_signature:[{types:[c]}]},avg:{_func:t=>{let e=0;const r=t[0];return r.forEach(t=>{e+=t}),e/r.length},_signature:[{types:[f]}]},ceil:{_func:t=>Math.ceil(t[0]),_signature:[{types:[c]}]},contains:{_func:t=>u(t[0]).indexOf(u(t[1]))>=0,_signature:[{types:[l,h]},{types:[a]}]},endsWith:{_func:t=>{const e=u(t[0]),r=u(t[1]);return-1!==e.indexOf(r,e.length-r.length)},_signature:[{types:[l]},{types:[l]}]},floor:{_func:t=>Math.floor(t[0]),_signature:[{types:[c]}]},length:{_func:t=>{const e=u(t[0]);return r(e)?Object.keys(e).length:n(e)?e.length:o(e).length},_signature:[{types:[l,h,_]}]},map:{_func:t=>{const r=t[0];return t[1].map(t=>e.visit(r,t))},_signature:[{types:[T]},{types:[h]}]},reduce:{_func:t=>{const r=t[0];return t[1].reduce((t,n,s,i)=>e.visit(r,{accumulated:t,current:n,index:s,array:i}),3===t.length?t[2]:null)},_signature:[{types:[T]},{types:[h]},{types:[a],optional:!0}]},max:{_func:t=>{if(t[0].length>0){const e=i(t[0][0]);return t[0].reduce(e===c?(t,e)=>s(t)>=s(e)?t:e:(t,e)=>o(e).localeCompare(o(t))<0?t:e,t[0][0])}return null},_signature:[{types:[h,f,d]}]},merge:{_func:t=>{const e={};return t.forEach(t=>{Object.entries(t).forEach(([t,r])=>{e[t]=r})}),e},_signature:[{types:[_],variadic:!0}]},maxBy:{_func:t=>{const e=t[0],r=y(t[1],[c,l]);let n,s,i=-Infinity;return e.forEach(t=>{s=r(t),s>i&&(i=s,n=t)}),n},_signature:[{types:[h]},{types:[T]}]},sum:{_func:t=>{let e=0;return t[0].forEach(t=>{e+=1*t}),e},_signature:[{types:[f]}]},startsWith:{_func:t=>u(t[0]).startsWith(u(t[1])),_signature:[{types:[l]},{types:[l]}]},min:{_func:t=>{if(t[0].length>0){if(i(t[0][0])===c)return t[0].reduce((t,e)=>s(t)<=s(e)?t:e,t[0][0]);const e=t[0];let r=e[0];for(let t=1;t<e.length;t+=1)o(e[t]).localeCompare(o(r))<0&&(r=e[t]);return r}return null},_signature:[{types:[h,f,d]}]},minBy:{_func:t=>{const e=t[0],r=y(t[1],[c,l]);let n,s,i=Infinity;return e.forEach(t=>{s=r(t),s<i&&(i=s,n=t)}),n},_signature:[{types:[h]},{types:[T]}]},type:{_func:t=>({[c]:"number",[l]:"string",[h]:"array",[_]:"object",[p]:"boolean",[T]:"expref",[E]:"null"}[i(t[0])]),_signature:[{types:[a]}]},keys:{_func:t=>null===t[0]?[]:Object.keys(t[0]),_signature:[{types:[a]}]},values:{_func:t=>{const e=u(t[0]);return null===e?[]:Object.values(e)},_signature:[{types:[a]}]},sort:{_func:t=>{const e=t[0].slice(0);if(e.length>0){const r=i(t[0][0])===c?s:o;e.sort((t,e)=>{const n=r(t),s=r(e);return n<s?-1:n>s?1:0})}return e},_signature:[{types:[h,d,f]}]},sortBy:{_func:t=>{const r=t[0].slice(0);if(0===r.length)return r;const n=t[1],s=i(e.visit(n,r[0]));if([c,l].indexOf(s)<0)throw new Error("TypeError");const u=[];for(let t=0;t<r.length;t+=1)u.push([t,r[t]]);u.sort((t,r)=>{const u=e.visit(n,t[1]),o=e.visit(n,r[1]);if(i(u)!==s)throw new Error(`TypeError: expected ${s}, received ${i(u)}`);if(i(o)!==s)throw new Error(`TypeError: expected ${s}, received ${i(o)}`);return u>o?1:u<o?-1:t[0]-r[0]});for(let t=0;t<u.length;t+=1)[,r[t]]=u[t];return r},_signature:[{types:[h]},{types:[T]}]},join:{_func:t=>t[1].join(t[0]),_signature:[{types:[l]},{types:[d]}]},reverse:{_func:t=>{const e=u(t[0]);if(i(e)===l){let t="";for(let r=e.length-1;r>=0;r-=1)t+=e[r];return t}const r=t[0].slice(0);return r.reverse(),r},_signature:[{types:[l,h]}]},toArray:{_func:t=>i(t[0])===h?t[0]:[t[0]],_signature:[{types:[a]}]},toString:{_func:t=>i(t[0])===l?t[0]:JSON.stringify(t[0]),_signature:[{types:[a]}]},toNumber:{_func:t=>{const e=i(t[0]);return e===c?t[0]:e===l?s(t[0]):null},_signature:[{types:[a]}]},notNull:{_func:t=>t.find(t=>i(t)!==E)||null,_signature:[{types:[a],variadic:!0}]},zip:{_func:t=>{const e=t.reduce((t,e)=>Math.min(t,e.length),t[0].length),r=new Array(e);for(let n=0;n<e;n+=1)r[n]=[],t.forEach(t=>{r[n].push(t[n])});return r},_signature:[{types:[h],variadic:!0}]}}}const{TYPE_CLASS:de,TYPE_ANY:ye}=t;var ge=new function(){let t;function e(t){return null==t?"":t.toString()}class r{addFunctions(r,n={}){this.functionTable={...fe(this._interpreter,O,g,t,f,R,e),...Ee(R,e,t,r),...n}}_validateArgs(r,n,s,i){if(0===s.length)return;let u;const o=s.filter(t=>!t.optional).length;if(s[s.length-1].variadic){if(n.length<s.length)throw u=1===s.length?" argument":" arguments",new Error(`ArgumentError: ${r}() takes at least${s.length}${u} but received ${n.length}`)}else if(n.length<o||n.length>s.length)throw u=1===s.length?" argument":" arguments",new Error(`ArgumentError: ${r}() takes ${s.length}${u} but received ${n.length}`);if(!i)return;let c,a;const l=Math.min(s.length,n.length);for(let i=0;i<l;i+=1)c=s[i].types,h=n[i],_=void 0,c.includes(de)&&null!==(_=h)&&!Array.isArray(_)&&"Object"!==_.constructor.name||c.includes(ye)||(a=d(n[i]),n[i]=y(a,c,n[i],r,t,e));var h,_}callFunction(t,e,r,n,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,t))throw new Error(`Unknown function: ${t}()`);const i=this.functionTable[t];return this._validateArgs(t,e,i._signature,s),i._func.call(this,e,r,n)}}this.compile=function(t,e=[],r=[]){let n;try{n=new pe(e).parse(t,r)}catch(t){throw r.push(t.toString()),t}return n},this.search=function(n,s,i,u,o,c=[],a="en-US"){const l=new r(u);l.debug=c,t=function(t,e=[]){return r=>{const n=R(r);if(null===n)return null;if(n instanceof Array)return e.push("Converted array to zero"),0;const s=typeof n;return"number"===s?n:"string"===s?t(n,e):"boolean"===s?n?1:0:(e.push("Converted object to zero"),0)}}(o||(t=>{const e=+t;return Number.isNaN(e)?0:e}),c);const h=new k(l,i,t,e,c,a);l._interpreter=h,l.addFunctions(c,u);try{return h.search(n,s)}catch(t){throw c.push(t.message||t.toString()),t}},this.strictDeepEqual=N};class Oe{constructor(t,e={},r=null,n=[],s=[],i="en-US"){this.expression=t,this.customFunctions=e,this.stringToNumber=r,this.node=ge.compile(t,n,s),this.debug=s,this.language=i}search(t,e){return ge.search(this.node,t,e,{...this.customFunctions},this.stringToNumber,this.debug,this.language)}}function Re(t,e,r,n={},s=null,i=[],u="en-US"){return new Oe(r,n,s,Object.keys(e),i,u).search(t,e,{...n},s,i,u)}export{Oe as Formula,Re as jsonFormula};
console.timeEnd("script json-formula")